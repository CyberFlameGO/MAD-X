# |
# o---------------------------------------------------------------------o
# |
# | MAD makefile - post-makefile MacOSX customization
# |
# o---------------------------------------------------------------------o
# |
# | Methodical Accelerator Design
# |
# | Copyright (c) 2011+ CERN, mad@cern.ch
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

#
# all
#
all-macosx:         all-macosx32        all-macosx64
all-macosx-gnu:     all-macosx32-gnu    all-macosx64-gnu
all-macosx-intel:   all-macosx32-intel  all-macosx64-intel

all-macosx32:       madx-macosx32 libmadx-macosx32 libptc-macosx32 numdiff-macosx32
all-macosx64:       madx-macosx64 libmadx-macosx64 libptc-macosx64 numdiff-macosx64

all-macosx32-gnu:   madx-macosx32-gnu libmadx-macosx32-gnu libptc-macosx32-gnu numdiff-macosx32-gnu
all-macosx64-gnu:   madx-macosx64-gnu libmadx-macosx64-gnu libptc-macosx64-gnu numdiff-macosx64-gnu

all-macosx32-intel: madx-macosx32-intel libmadx-macosx32-intel libptc-macosx32-intel numdiff-macosx32-intel
all-macosx64-intel: madx-macosx64-intel libmadx-macosx64-intel libptc-macosx64-intel numdiff-macosx64-intel

#
# madx
#
madx-macosx:        madx-macosx32         madx-macosx64
madx-macosx-gnu:    madx-macosx32-gnu     madx-macosx64-gnu
madx-macosx-intel:  madx-macosx32-intel   madx-macosx64-intel

.PHONY: madx-macosx32       madx-macosx64
.PHONY: madx-macosx32-gnu   madx-macosx64-gnu
.PHONY: madx-macosx32-intel madx-macosx64-intel

madx-macosx%: MAKE_ARGS = PRJNAME=$@ DESTDIR=$(DESTDIR) ONLINE=no STATIC=yes USEGC=yes APPENDLD=yes
madx-macosx%: MAKE_OPTS = -j9 $(MAKEFLAGS) $(MAKEOVERRIDES)
madx-macosx%: MAKE_LINK = $(if $(DESTDIR),ln -sf $(DESTDIR)$@ &&,) ln -sf $@ 

madx-macosx32-intel madx-macosx32: libs/gc/libgc-macosx32-intel.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 Intel=yes && $(MAKE_LINK) madx32

madx-macosx64-intel madx-macosx64: libs/gc/libgc-macosx64-intel.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 Intel=yes && $(MAKE_LINK) madx64

madx-macosx32-gnu: libs/gc/libgc-macosx32-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 GNU=yes && $(MAKE_LINK) madx32

madx-macosx64-gnu: libs/gc/libgc-macosx64-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 GNU=yes && $(MAKE_LINK) madx64

#
# libgc
#
libs/gc/libgc-macosx%: MAKE_OPTS = -j9 --no-print-directory -C libs/gc

libs/gc/libgc-macosx32-intel.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-intel32

libs/gc/libgc-macosx64-intel.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-intel64

libs/gc/libgc-macosx32-gnu.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-gnu32

libs/gc/libgc-macosx64-gnu.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-gnu64

#
# libmadx
#
libmadx-macosx:       libmadx-macosx32        libmadx-macosx64
libmadx-macosx-gnu:   libmadx-macosx32-gnu    libmadx-macosx64-gnu
libmadx-macosx-intel: libmadx-macosx32-intel  libmadx-macosx64-intel

libmadx-macosx%: DESTDIR   := $(DESTDIR)libs/madx
libmadx-macosx%: MAKE_ARGS  = PRJNAME=$@ DESTDIR=../../$(DESTDIR) ONLINE=no STATIC=yes USEGC=yes APPENDLD=yes
libmadx-macosx%: MAKE_OPTS  = -j9 --no-print-directory -C libs/madx $(MAKEFLAGS) $(MAKEOVERRIDES)
libmadx-macosx%: MAKE_LINK1 = ln -sf $(DESTDIR)/$@.a     && ln -sf $@.a
libmadx-macosx%: MAKE_LINK2 = ln -sf $(DESTDIR)/$@.dylib && ln -sf $@.dylib

libmadx-macosx32-intel libmadx-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 Intel=yes && $(MAKE_LINK1) libmadx32.a && $(MAKE_LINK2) libmadx32.dylib

libmadx-macosx64-intel libmadx-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 Intel=yes && $(MAKE_LINK1) libmadx64.a && $(MAKE_LINK2) libmadx64.dylib

libmadx-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 GNU=yes && $(MAKE_LINK1) libmadx32.a && $(MAKE_LINK2) libmadx32.dylib

libmadx-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 GNU=yes && $(MAKE_LINK1) libmadx64.a && $(MAKE_LINK2) libmadx64.dylib

#
# libptc
#
libptc-macosx:        libptc-macosx32        libptc-macosx64
libptc-macosx-gnu:    libptc-macosx32-gnu    libptc-macosx64-gnu
libptc-macosx-intel:  libptc-macosx32-intel  libptc-macosx64-intel

libptc-macosx%: DESTDIR   := $(DESTDIR)libs/ptc
libptc-macosx%: MAKE_ARGS  = PRJNAME=$@ DESTDIR=../../$(DESTDIR) STATIC=yes APPENDLD=yes
libptc-macosx%: MAKE_OPTS  = -j9 --no-print-directory -C libs/ptc $(MAKEFLAGS) $(MAKEOVERRIDES)
libptc-macosx%: MAKE_LINK1 = ln -sf $(DESTDIR)/$@.a     && ln -sf $@.a
libptc-macosx%: MAKE_LINK2 = ln -sf $(DESTDIR)/$@.dylib && ln -sf $@.dylib

libptc-macosx32-intel libptc-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 Intel=yes && $(MAKE_LINK1) libptc32.a && $(MAKE_LINK2) libptc32.dylib

libptc-macosx64-intel libptc-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 Intel=yes && $(MAKE_LINK1) libptc64.a && $(MAKE_LINK2) libptc64.dylib

libptc-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 GNU=yes && $(MAKE_LINK1) libptc32.a && $(MAKE_LINK2) libptc32.dylib

libptc-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 GNU=yes && $(MAKE_LINK1) libptc64.a && $(MAKE_LINK2) libptc64.dylib

#
# numdiff
#
numdiff-macosx:       numdiff-macosx32        numdiff-macosx64
numdiff-macosx-gnu:   numdiff-macosx32-gnu    numdiff-macosx64-gnu
numdiff-macosx-intel: numdiff-macosx32-intel  numdiff-macosx64-intel

numdiff-macosx%: DESTDIR  := $(DESTDIR)tools/numdiff
numdiff-macosx%: MAKE_ARGS = PRJNAME=$@ DESTDIR=../../$(DESTDIR) STATIC=yes APPENDLD=yes
numdiff-macosx%: MAKE_OPTS = -j9 --no-print-directory -C tools/numdiff $(MAKEFLAGS) $(MAKEOVERRIDES)
numdiff-macosx%: MAKE_LINK = ln -sf $(DESTDIR)/$@ && ln -sf $@

numdiff-macosx32-intel numdiff-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 Intel=yes && $(MAKE_LINK) numdiff32

numdiff-macosx64-intel numdiff-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 Intel=yes && $(MAKE_LINK) numdiff64

numdiff-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 GNU=yes && $(MAKE_LINK) numdiff32

numdiff-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 GNU=yes && $(MAKE_LINK) numdiff64

# end of makefile
