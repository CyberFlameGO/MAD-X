# |
# o---------------------------------------------------------------------o
# |
# | MAD makefile - post-makefile MacOSX customization
# |
# o---------------------------------------------------------------------o
# |
# | Methodical Accelerator Design
# |
# | Copyright (c) 2011+ CERN, mad@cern.ch
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

#
# all
#
all-macosx:         all-macosx32        all-macosx64
all-macosx-gnu:     all-macosx32-gnu    all-macosx64-gnu
all-macosx-llvm:    all-macosx32-llvm   all-macosx64-llvm
all-macosx-intel:   all-macosx32-intel  all-macosx64-intel

all-macosx32:       madx-macosx32 libmadx-macosx32 libptc-macosx32 numdiff-macosx32
all-macosx64:       madx-macosx64 libmadx-macosx64 libptc-macosx64 numdiff-macosx64

all-macosx32-gnu:   madx-macosx32-gnu libmadx-macosx32-gnu libptc-macosx32-gnu numdiff-macosx32-gnu
all-macosx64-gnu:   madx-macosx64-gnu libmadx-macosx64-gnu libptc-macosx64-gnu numdiff-macosx64-gnu

all-macosx32-llvm:  madx-macosx32-llvm libmadx-macosx32-llvm libptc-macosx32-llvm numdiff-macosx32-llvm
all-macosx64-llvm:  madx-macosx64-llvm libmadx-macosx64-llvm libptc-macosx64-llvm numdiff-macosx64-llvm

all-macosx32-intel: madx-macosx32-intel libmadx-macosx32-intel libptc-macosx32-intel numdiff-macosx32-intel
all-macosx64-intel: madx-macosx64-intel libmadx-macosx64-intel libptc-macosx64-intel numdiff-macosx64-intel

#
# cleanbuild platform specific
#
cleanarch:
	$E "** Cleaning binaries and libraries"
	$_ $(RM) $(wildcard madx32 madx64 numdiff32 numdiff64 libmadx32* libmadx64* libptc32* libptc64*)
	$_ $(RM) $(wildcard madx-macosx* libmadx-macosx* libptc-macosx* numdiff-macosx* libs/gc/libgc*.a)

#
# madx
#
madx-macosx:        madx-macosx32         madx-macosx64
madx-macosx-gnu:    madx-macosx32-gnu     madx-macosx64-gnu
madx-macosx-llvm:   madx-macosx32-llvm    madx-macosx64-llvm
madx-macosx-intel:  madx-macosx32-intel   madx-macosx64-intel

.PHONY: madx-macosx32       madx-macosx64
.PHONY: madx-macosx32-gnu   madx-macosx64-gnu
.PHONY: madx-macosx32-llvm  madx-macosx64-llvm
.PHONY: madx-macosx32-intel madx-macosx64-intel

madx-macosx%: MAKE_ARGS = PRJNAME=$@ DESTDIR=$(DESTDIR) ONLINE=no STATIC=yes USEGC=yes APPENDLD=yes
madx-macosx%: MAKE_OPTS = -j9 $(MAKEARGS)
madx-macosx%: MAKE_LINK = $(if $(DESTDIR),ln -sf $(DESTDIR)$@ &&,) ln -sf $@ 

madx-macosx32-intel madx-macosx32: libs/gc/libgc-macosx32-intel.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=intel && $(MAKE_LINK) madx32

madx-macosx64-intel madx-macosx64: libs/gc/libgc-macosx64-intel.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=intel && $(MAKE_LINK) madx64

madx-macosx32-gnu: libs/gc/libgc-macosx32-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=gnu && $(MAKE_LINK) madx32

madx-macosx64-gnu: libs/gc/libgc-macosx64-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=gnu && $(MAKE_LINK) madx64

madx-macosx32-llvm: libs/gc/libgc-macosx32-llvm.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=llvm && $(MAKE_LINK) madx32

madx-macosx64-llvm: libs/gc/libgc-macosx64-llvm.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=llvm && $(MAKE_LINK) madx64

#
# libgc
#
libs/gc/libgc-macosx%: MAKE_OPTS = -j9 --no-print-directory -C libs/gc

# BUG in GC 7.2f or Intel 14.0.4
# remove the 2 rules and uncomment the 2 right after when it is solved...
# to check if it solved, we (still) build libgc32/64-intel and run the tests...

libs/gc/libgc-macosx32-intel.a: libs/gc/libgc-macosx32-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-intel32 ; \
	   cd libs/gc ; ln -sf libgc32-gnu.a libgc32-intel.a

libs/gc/libgc-macosx64-intel.a: libs/gc/libgc-macosx64-gnu.a
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-intel64 ; \
	   cd libs/gc ; ln -sf libgc64-gnu.a libgc64-intel.a

# libs/gc/libgc-macosx32-intel.a:
#	$E "*** Building $@"
#	$_ $(MAKE) $(MAKE_OPTS) libgc-intel32

#libs/gc/libgc-macosx64-intel.a:
#	$E "*** Building $@"
#	$_ $(MAKE) $(MAKE_OPTS) libgc-intel64

libs/gc/libgc-macosx32-gnu.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-gnu32

libs/gc/libgc-macosx64-gnu.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-gnu64

libs/gc/libgc-macosx32-llvm.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-llvm32

libs/gc/libgc-macosx64-llvm.a:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_OPTS) libgc-llvm64

#
# libmadx
#
libmadx-macosx:       libmadx-macosx32        libmadx-macosx64
libmadx-macosx-gnu:   libmadx-macosx32-gnu    libmadx-macosx64-gnu
libmadx-macosx-llvm:  libmadx-macosx32-llvm   libmadx-macosx64-llvm
libmadx-macosx-intel: libmadx-macosx32-intel  libmadx-macosx64-intel

libmadx-macosx%: DESTDIR   := $(DESTDIR)libs/madx
libmadx-macosx%: MAKE_ARGS  = PRJNAME=$@ DESTDIR=../../$(DESTDIR) ONLINE=no STATIC=no USEGC=yes APPENDLD=yes
libmadx-macosx%: MAKE_OPTS  = -j9 --no-print-directory -C libs/madx $(MAKEARGS)
libmadx-macosx%: MAKE_LINK1 = ln -sf $(DESTDIR)/$@.a     && ln -sf $@.a
libmadx-macosx%: MAKE_LINK2 = ln -sf $(DESTDIR)/$@.dylib && ln -sf $@.dylib

libmadx-macosx32-intel libmadx-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=intel && $(MAKE_LINK1) libmadx32.a && $(MAKE_LINK2) libmadx32.dylib

libmadx-macosx64-intel libmadx-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=intel && $(MAKE_LINK1) libmadx64.a && $(MAKE_LINK2) libmadx64.dylib

libmadx-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=gnu && $(MAKE_LINK1) libmadx32.a && $(MAKE_LINK2) libmadx32.dylib

libmadx-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=gnu && $(MAKE_LINK1) libmadx64.a && $(MAKE_LINK2) libmadx64.dylib

libmadx-macosx32-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=llvm && $(MAKE_LINK1) libmadx32.a && $(MAKE_LINK2) libmadx32.dylib

libmadx-macosx64-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=llvm && $(MAKE_LINK1) libmadx64.a && $(MAKE_LINK2) libmadx64.dylib

#
# libptc
#
libptc-macosx:        libptc-macosx32        libptc-macosx64
libptc-macosx-gnu:    libptc-macosx32-gnu    libptc-macosx64-gnu
libptc-macosx-llvm:   libptc-macosx32-llvm   libptc-macosx64-llvm
libptc-macosx-intel:  libptc-macosx32-intel  libptc-macosx64-intel

libptc-macosx%: DESTDIR   := $(DESTDIR)libs/ptc
libptc-macosx%: MAKE_ARGS  = PRJNAME=$@ DESTDIR=../../$(DESTDIR) STATIC=no APPENDLD=yes
libptc-macosx%: MAKE_OPTS  = -j9 --no-print-directory -C libs/ptc $(MAKEARGS)
libptc-macosx%: MAKE_LINK1 = ln -sf $(DESTDIR)/$@.a     && ln -sf $@.a
libptc-macosx%: MAKE_LINK2 = ln -sf $(DESTDIR)/$@.dylib && ln -sf $@.dylib

libptc-macosx32-intel libptc-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=intel && $(MAKE_LINK1) libptc32.a && $(MAKE_LINK2) libptc32.dylib

libptc-macosx64-intel libptc-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=intel && $(MAKE_LINK1) libptc64.a && $(MAKE_LINK2) libptc64.dylib

libptc-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=gnu && $(MAKE_LINK1) libptc32.a && $(MAKE_LINK2) libptc32.dylib

libptc-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=gnu && $(MAKE_LINK1) libptc64.a && $(MAKE_LINK2) libptc64.dylib

libptc-macosx32-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=llvm && $(MAKE_LINK1) libptc32.a && $(MAKE_LINK2) libptc32.dylib

libptc-macosx64-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=llvm && $(MAKE_LINK1) libptc64.a && $(MAKE_LINK2) libptc64.dylib

#
# numdiff
#
numdiff-macosx:       numdiff-macosx32        numdiff-macosx64
numdiff-macosx-gnu:   numdiff-macosx32-gnu    numdiff-macosx64-gnu
numdiff-macosx-llvm:  numdiff-macosx32-llvm   numdiff-macosx64-llvm
numdiff-macosx-intel: numdiff-macosx32-intel  numdiff-macosx64-intel

numdiff-macosx%: DESTDIR  := $(DESTDIR)tools/numdiff
numdiff-macosx%: MAKE_ARGS = PRJNAME=$@ DESTDIR=../../$(DESTDIR) STATIC=yes APPENDLD=yes
numdiff-macosx%: MAKE_OPTS = -j9 --no-print-directory -C tools/numdiff $(MAKEARGS)
numdiff-macosx%: MAKE_LINK = ln -sf $(DESTDIR)/$@ && ln -sf $@

numdiff-macosx32-intel numdiff-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=intel && $(MAKE_LINK) numdiff32

numdiff-macosx64-intel numdiff-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=intel && $(MAKE_LINK) numdiff64

numdiff-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=gnu && $(MAKE_LINK) numdiff32

numdiff-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=gnu && $(MAKE_LINK) numdiff64

numdiff-macosx32-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=32 COMP=llvm && $(MAKE_LINK) numdiff32

numdiff-macosx64-llvm:
	$E "*** Building $@"
	$_ $(MAKE) $(MAKE_ARGS) $(MAKE_OPTS) ARCH=64 COMP=llvm && $(MAKE_LINK) numdiff64

# end of makefile
