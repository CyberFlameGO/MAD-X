# |
# o---------------------------------------------------------------------o
# |
# | MAD makefile - post-makefile MacOSX customization
# |
# o---------------------------------------------------------------------o
# |
# | Methodical Accelerator Design
# |
# | Copyright (c) 2011+ CERN, mad@cern.ch
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

# use macport GCC suite
ifeq ($(USER),ldeniau)
%-gnu:        GNUMAC := CC=gcc-mp-4.7 CXX=g++-mp-4.7 FC=gfortran-mp-4.7 LD=gfortran-mp-4.7 \
                        CCNAME=gcc CXXNAME=g++ FCNAME=gfortran LDNAME=gfortran
numdiff%-gnu: GNUMAC := CC=gcc-mp-4.7 LD=gcc-mp-4.7 CCNAME=gcc LDNAME=gcc
else
%-gnu: GNUMAC := GNU=yes
endif

#
# all
#
.PHONY: all-macosx all-macosx-gnu

all-macosx:     madx-macosx     libmadx-macosx     libptc-macosx     numdiff-macosx
all-macosx-gnu: madx-macosx-gnu libmadx-macosx-gnu libptc-macosx-gnu numdiff-macosx-gnu

#
# madx
#
.PHONY:             madx-macosx           madx-macosx-gnu
.PHONY:             madx-macosx32         madx-macosx64
.PHONY:             madx-macosx32-gnu     madx-macosx64-gnu
madx-macosx:        madx-macosx32         madx-macosx64
madx-macosx-gnu:    madx-macosx32-gnu     madx-macosx64-gnu

madx-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) --no-print-directory -j5 ARCH=32 ONLINE=no STATIC=no Intel=yes APPENDLD=yes && \
     $(CP) madx32 $@

madx-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) --no-print-directory -j5 ARCH=64 ONLINE=no STATIC=no Intel=yes APPENDLD=yes && \
     $(CP) madx64 $@

madx-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) --no-print-directory -j5 ARCH=32 ONLINE=no STATIC=no $(GNUMAC) APPENDLD=yes && \
     $(CP) madx32 $@

madx-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) --no-print-directory -j5 ARCH=64 ONLINE=no STATIC=no $(GNUMAC) APPENDLD=yes && \
     $(CP) madx64 $@

#
# libmadx
#
.PHONY:             libmadx-macosx        libmadx-macosx-gnu
.PHONY:             libmadx-macosx32      libmadx-macosx64
.PHONY:             libmadx-macosx32-gnu  libmadx-macosx64-gnu
libmadx-macosx:     libmadx-macosx32      libmadx-macosx64
libmadx-macosx-gnu: libmadx-macosx32-gnu  libmadx-macosx64-gnu

libmadx-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/madx --no-print-directory -j5 ARCH=32 ONLINE=no STATIC=no Intel=yes APPENDLD=yes && \
     $(CP) libs/madx/libmadx32.a     $@.a     && ln -sf $@.a     libmadx32.a && \
     $(CP) libs/madx/libmadx32.dylib $@.dylib && ln -sf $@.dylib libmadx32.dylib

libmadx-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/madx --no-print-directory -j5 ARCH=64 ONLINE=no STATIC=no Intel=yes APPENDLD=yes && \
     $(CP) libs/madx/libmadx64.a     $@.a     && ln -sf $@.a     libmadx64.a && \
     $(CP) libs/madx/libmadx64.dylib $@.dylib && ln -sf $@.dylib libmadx64.dylib

libmadx-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/madx --no-print-directory -j5 ARCH=32 ONLINE=no STATIC=no $(GNUMAC) APPENDLD=yes && \
     $(CP) libs/madx/libmadx32.a     $@.a     && ln -sf $@.a      libmadx32.a && \
     $(CP) libs/madx/libmadx32.dylib $@.dylib && ln -sf $@.dylib libmadx32.dylib

libmadx-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/madx --no-print-directory -j5 ARCH=64 ONLINE=no STATIC=no $(GNUMAC) APPENDLD=yes && \
     $(CP) libs/madx/libmadx64.a     $@.a     && ln -sf $@.a     libmadx64.a && \
     $(CP) libs/madx/libmadx64.dylib $@.dylib && ln -sf $@.dylib libmadx64.dylib

#
# libptc
#
.PHONY:             libptc-macosx        libptc-macosx-gnu
.PHONY:             libptc-macosx32      libptc-macosx64
.PHONY:             libptc-macosx32-gnu  libptc-macosx64-gnu
libptc-macosx:      libptc-macosx32      libptc-macosx64
libptc-macosx-gnu:  libptc-macosx32-gnu  libptc-macosx64-gnu

libptc-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/ptc --no-print-directory -j5 ARCH=32 Intel=yes APPENDLD=yes && \
     $(CP) libs/ptc/libptc32.a     $@.a     && ln -sf $@.a     libptc32.a && \
     $(CP) libs/ptc/libptc32.dylib $@.dylib && ln -sf $@.dylib libptc32.dylib

libptc-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/ptc --no-print-directory -j5 ARCH=64 Intel=yes APPENDLD=yes && \
     $(CP) libs/ptc/libptc64.a     $@.a     && ln -sf $@.a     libptc64.a && \
     $(CP) libs/ptc/libptc64.dylib $@.dylib && ln -sf $@.dylib libptc64.dylib

libptc-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/ptc --no-print-directory -j5 ARCH=32 $(GNUMAC) APPENDLD=yes && \
     $(CP) libs/ptc/libptc32.a     $@.a     && ln -sf $@.a     libptc32.a && \
     $(CP) libs/ptc/libptc32.dylib $@.dylib && ln -sf $@.dylib libptc32.dylib

libptc-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C libs/ptc --no-print-directory -j5 ARCH=64 $(GNUMAC) APPENDLD=yes && \
     $(CP) libs/ptc/libptc64.a     $@.a     && ln -sf $@.a     libptc64.a && \
     $(CP) libs/ptc/libptc64.dylib $@.dylib && ln -sf $@.dylib libptc64.dylib

#
# numdiff
#
.PHONY:             numdiff-macosx        numdiff-macosx-gnu
.PHONY:             numdiff-macosx32      numdiff-macosx64
.PHONY:             numdiff-macosx32-gnu  numdiff-macosx64-gnu
numdiff-macosx:     numdiff-macosx32      numdiff-macosx64
numdiff-macosx-gnu: numdiff-macosx32-gnu  numdiff-macosx64-gnu

numdiff-macosx32:
	$E "*** Building $@"
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ARCH=32 Intel=yes APPENDLD=yes && \
     $(CP) tools/numdiff/numdiff32 $@ && ln -sf $@ numdiff32

numdiff-macosx64:
	$E "*** Building $@"
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ARCH=64 Intel=yes APPENDLD=yes && \
     $(CP) tools/numdiff/numdiff64 $@ && ln -sf $@ numdiff64

numdiff-macosx32-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ARCH=32 $(GNUMAC) APPENDLD=yes && \
     $(CP) tools/numdiff/numdiff32 $@ && ln -sf $@ numdiff32

numdiff-macosx64-gnu:
	$E "*** Building $@"
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ARCH=64 $(GNUMAC) APPENDLD=yes && \
     $(CP) tools/numdiff/numdiff64 $@ && ln -sf $@ numdiff64

# end of makefile
