mydrift: drift, l=1;
qfk1 := 5.08623;
qdk1 := 5.08623;
qf: quadrupole, l=0.1, k1:= qfk1;
qd: quadrupole, l=0.1, k1:=-qdk1;



l1: line:=(qf, mydrift, qd, m1, mydrift);
m: marker;
m1: marker;

qs: quadrupole, l=0.01, k1s:=1e-9;
sx1: sextupole, l=0.01, k2:=0.1;

myline: line:=(l1,l1,l1,l1,m);




beam,particle=proton, energy=6500, ex=5e-5, ey=5.E-10, sigt=0.077, sige=1.1E-4;
use, period=myline;



select,flag=ptc_twiss,clear;
select, flag=ptc_twiss, column=name,s,Energy,beta11,beta22,beta33,alfa11,alfa22,mu1,mu2,mu3,disp1,disp2,
                          re11,re12,re13,re14,re15,re16,
                          re21,re22,re23,re24,re25,re26,
                          re31,re32,re33,re34,re35,re36,
                          re41,re42,re43,re44,re45,re46,
                          re51,re52,re53,re54,re55,re56,
                          re61,re62,re63,re64,re65,re66;



ptc_create_universe;
  ptc_create_layout, model=1, method=6, nst=5, exact=true, closed_layout=true;
  
!  ptc_knob, element=QFN24,   kn=0,1, exactmatch=false;
!  ptc_printframes, file="leir.C", format=rootmacro;!this prints my visualisation with ROOT

  !!!!!       T I M E   T R U E ,   T O T P A T H  F A L S E
  ptc_setswitch, debuglevel=0, exact_mis=true, time=true, totalpath=false;


  
  ptc_twiss, table=twiss, icase=56, no=3, closed_orbit, normal;
!  ptc_twiss, icase=6, no=2, betx=10, bety=10,betz=10;
  
!  plot, table=ptc_twiss, vaxis=beta11,beta22, haxis=s;
!  plot, table=ptc_twiss, vaxis=mu3, haxis=s;
!  plot, table=ptc_twiss, vaxis=energy, haxis=s;
  
  write, table=twiss, file="ptc.twiss";
  write, table=ptc_twiss_summary, file="ptc.summ.twiss";
  write, table=nonlin, file="ptc.nonlin";

ptc_end;


plot, haxis=s, vaxis=beta11,beta22, colour=100;
plot, haxis=s, vaxis=disp1, colour=100;
!plot, haxis=s, vaxis=x, colour=100;

!removefile, file='leir.C';
removefile, file='Maxwellian_bend_for_ptc.txt';

bx = table(twiss, m, beta11);
by = table(twiss, m, beta22);
qx = table(twiss, myline$end, mu1);
qy = table(twiss, myline$end, mu2);

k1s_l = 1*0.01;

na = k1s_l*sqrt(bx*by);

dc = 4*(1-cos(qx-qy));
dd = 4*sin(qx-qy);

f1001_de = dc*dc+dd*dd;

f1001_re = na*dc/f1001_de;
f1001_im = -na*dd/f1001_de;

value, f1001_re, f1001_im;



value, table(nonlin, GNFC_1_0_0_1_1_0,value),table(twiss, GNFC_1_0_0_1_1_0,value);
