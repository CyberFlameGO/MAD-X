%%\title{PTC\_NORMAL Module (Non-Linear Machine Parameters)}
%  Created by: Valery KAPIN, 21-Mar-2006 

\chapter{PTC\_NORMAL Module: Non-Linear Machine Parameters}

The {\bf PTC\_NORMAL module} of MAD-X
[\hyperlink{F._Schmidt}{a},\hyperlink{d Amico}{b}] is based on PTC
code. This module takes full advantage of the PTC Normal Form analysis
which is  a  considerable upgrade of what was available with
the Lie Algebra   technique used in MAD8. It allows to calculate
dispersions, chromaticities,   anharmonicities and Hamiltonian terms to
very high order. In fact, the order is   only limited by the RAM memory
of your computer and your patience to wait for   the results.  

The number of terms per order increases with some power law. The
internal MAD-X   tables are not adequate to keep such large amounts of
data. On the other hand,   only a reduced set of this data is actually
needed by the user. Thus a much   easier and flexible solution is to
gather the users  requirements with a series   of special MAD-X command
called \texttt{SELECT\_PTC\_NORMAL}. A   special MAD-X table is
dynamically built using just those commands and it will   be filled by
the next call to the \texttt{PTC\_NORMAL}-command.  

Another essential advantage of this table is the fact that it is
structured to   facilitate exchange of Normal Form (including
Hamiltonian terms of high order)   between MAD-X modules. The immediate
goal is to use this table to allow   non-linear matching inside the
present MAD-X MATCHING module. 

{\bf Synopsis} \\
\begin{verbatim}
PTC_CREATE_UNIVERSE;
PTC_CREATE_LAYOUT, model=integer, method=integer, nst=integer, [exact];
...
SELECT_PTC_NORMAL, dx,..., gnfu;
...
PTC_NORMAL;
WRITE, table=normal_results, file=normal_results;
...
PTC_END; 
\end{verbatim}

\section{Select\_PTC\_Normal} 

\begin{verbatim}
SELECT_PTC_NORMAL, 
    dx=integer, dpx=integer, dy=integer, dpy=integer,
    q1=0, dq1=integer, q2=0, dq2=integer,         
    anhx=integer array, anhy=integer array, 
    gnfu=integer,0,0, haml=integer,0,0,
    eign=integer, integer;
\end{verbatim}

{\bf Description} \\
The \texttt{SELECT\_PTC\_NORMAL }command selects parameters to be
calculated by the next \texttt{PTC\_NORMAL }command. The dispersion and
tune parameters are defined by a name and an integer number specifying
their order. For example, the notation "dx=2" means the horizontal
dispersion to second order 
\textit{D$_x$}$^{(2)}$=$\partial$$^{(2)}$\textit{x}$_{co}$/
$\partial$\textit{$\delta$}$_\textit{p}$$^{(2)}$, 
where "co" is abbreviation of "closed orbit". The anharmonicities are
defined by a name and three integer numbers: the first is the order of
\textit{$\epsilon$}$_1$, the second is the order of
\textit{$\epsilon$}$_2$, the third is the order of
\textit{$\delta$}$_\textit{p}$. For example, the notation
"anhx=2,0,0" means second order in \textit{$\epsilon$}$_1$:
$\partial$$^{(2)}$\textit{q}$_1$/$\partial$\textit{$\epsilon$}$_1$$^{(2)}$.
        
Components of the eigenvectors at the end of the structure can be
specified by two integers: the first integer defines the
eigenvector number, the second integer defines the coordinate
\{\textit{x}, \textit{p$_x$}, \textit{y}, \textit{p$_y$},
\textit{t},\textit{p$_t$}\}.

The Generating Function can be specified by \{ \textit{n}, 0, 0\}. The
positive and negative values of \textit{n} define the order of upright
or skew resonances, respectively. The integers \textit{n}$_2$ and
\textit{n}$_3$ are reserved for a future upgrade. For example, "gnfu=-5,
0, 0" will calculate all Generating Function terms for skew
decapoles. In the output table, one finds the cosine, sine and amplitude
coefficients as denoted by "GNFC", "GNFS", and "GNFA", respectively.

Similarily, the Hamiltonian terms can be specified by \{\textit{n}, 0,
0\}. The positive and negative values of \textit{n} define the order of
upright or skew resonances, respectively. For example, "haml=3, 0, 0"
will calculate all Hamiltonian terms for upright sextupoles. In the
output table, one finds the cosine, sine and amplitude coefficients as
denoted by "HAMC", "HAMS", and "HAMA", respectively. 


{\bf Parameters} \\
\begin{tabular}{p{2cm} p{7cm} p{2cm}}
  \hline 
  \textbf{Notation} & \textbf{Meaning} & \textbf{Value} \\ 
  \hline
  DX, DPX, DY,DPY & 
  dispersions, \textit{D$_x$}$^{(n)}$,
  \textit{D$_px$}$^{(n)}$, \textit{D$_y$}$^{(n)}$,
  \textit{D$_py$}$^{(n)}$ & \textit{n} \\ 
  \hline
  Q1, Q2 & 
  horizontal and vertical tunes \textit{q}$_1$$^{(0)}$,
  \textit{q}$_2$$^{(0)}$ &  0 \\  
  \hline
  DQ1, DQ2 & 
  derivatives of horizontal and vertical tunes
  $\partial$$^{(n)}$\textit{q}$_1$/$\partial$\textit{$\delta$}$_\textit{p}$$^{(n)}$,
  $\partial$$^{(n)}$\textit{q}$_2$/$\partial$\textit{$\delta$}$_\textit{p}$$^{(n)}$
  & \textit{n} \\  
  \hline
  ANHX, ANHY 
  & Anharmonicities &
  \textit{n}(\textit{$\epsilon$}$_1$),
  \textit{n}(\textit{$\epsilon$}$_2$),
  \textit{n}(\textit{$\delta$}$_\textit{p}$) \\  
  \hline
  GNFU & Generating Function & \textit{n}, 0, 0 \\ 
  \hline
  HAML & Hamiltonian  & \textit{n}, 0, 0 \\ 
  \hline
  EIGN & Eigenvector (the \textit{n}$_2$-th component of the
  \textit{n}$_1$-th eigenvector) & \textit{n}$_1$, \textit{n}$_2$
  \\  
  \hline
\end{tabular}




\section{PTC\_Normal}

\begin{verbatim}
PTC_NORMAL, icase=integer, normal, closed_orbit, 
            no=integer, map_table, deltap=double;
\end{verbatim}

The calculation of the parameters specified by the preceding
\texttt{SELECT\_PTC\_NORMAL } commands is initiated by the
\texttt{PTC\_NORMAL }command, which operates on the working beam
line defined in the latest \href{../control/general.html#use}{
  USE} command. The options for \texttt{PTC\_NORMAL }command are
described in the table below.  

{\bf Options} \\
\begin{itemize}
  \item {\bf ICASE}=integer (Default: 4)\\
    the user-defined dimensionality of the phase-space (4, 5 or 6).

  \item {\bf NO}=integer (Default: 1)\\ 
    the order of the map. 
    
  \item {\bf CLOSED\_ORBIT}=logical (Default: .false.) \\
    the switch to turn on the closed orbit calculation. 

  \item {\bf DELTAP}=double (Default: 0.0) \\
    relative momentum offset for reference closed orbit.

  \item {\bf MAPTABLE}=logical (Default: .false.) 
    turn on the map-table in memory.

  \item{\bf NORMAL}=logical (Default: .false.)\\
    turn on the calculation of the Normal Form.
\end{itemize}


{\bf Remarks} \\ 
\textbf{MAPTABLE}: (requires no=1) creates the one-turn matrix which can
be used by the next \href{../ptc_twiss/ptc_twiss.html}{PTC\_TWISS} command. 
  
{\bf Example}\\
The simple example is located on the Web-page for the
\href{http://cern.ch/frs/mad-X_examples/ptc_normal}{\texttt{PTC\_NORMAL}
  example}. 

{\bf References for PTC\_NORMAL} \\
\begin{enumerate}
   \item \href{F._Schmidt}{F. Schmidt},
     "`\href{http://cern.ch/madx/doc/MPPE012.pdf}{MAD-X PTC Integration}'',
     Proc. of the 2005 PAC Conference in Knoxville, USA, pp.1272. 
   \item E.T. \href{d Amico}{d Amico}, "Nonlinear parameters from PTC",
     \href{http://cern.ch/frs/MAD-X_minutes/Meeting-7}{MAD-X Meeting 7
       (29.11.2004)}, notes
     (\href{http://cern.ch/frs/MAD-X_minutes/Meeting-7/Nonlinear_parameters_from_PTC.doc}{doc}-file). 
   \item \href{A._Schoch}{A. Schoch}, "Theory of linear and non-linear
     perturbations of betatron oscillations in alternating-gradient
     synchrotrons ",
     \href{http://cern.ch/madx/doc/yellow-report-1957.pdf}{CERN-27-21}, 1958. 
\end{enumerate}

{\bf See Also}\\
\href{http://cern.ch/frs/mad-X_examples/ptc_normal}{\texttt{PTC\_NORMAL} example}, 
\href{../ptc_general/ptc_general.html}{PTC Set-up Parameters}. 



%\href{mailto:kapin@itep.ru}{  V.Kapin}(ITEP) and 
%\href{mailto:Frank.Schmidt@cern.ch}{  F.Schmidt}, March  2006

