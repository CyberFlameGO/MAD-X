%%\title{MAKETHIN}
%  Changed by: Helmut Burkhardt,  7-April-2005 
 
\chapter{MAKETHIN: Slice a sequence into thin lenses}
\label{chap:makethin}

This module converts a sequence with thick elements into one composed of
thin (zero length) element slices or simplified thick slices as required
by MAD-X tracking or conversion to SIXTRACK input format.

The slicing is performed by the command: 
\begin{verbatim}
MAKETHIN, SEQUENCE=seq_name,
          STYLE=slicing_style,
          MINIMIZEPARENTS= ??, MAKECONSISTENT= ??, MAKEDIPEDGE= ??; 
\end{verbatim} 

The parameters are defined as: 
\begin{madlist}
   \ttitem{SEQUENCE} seq\_name is the name of the sequence to be
   processed to thin slices. The sequence must be active, i.e. it should
   have been previously loaded with a USE command.  

   \ttitem{STYLE} the slicing\_style provided as argument is optional
   and selects the slicing style. Available slicing styles are:     

     \begin{madlist}
     \ttitem{SIMPLE} is a simplified slicing algorithm which produces
     equal strength slices at equidistant positions with the kick in the
     middle of each slice. \\ 
     It is the default if the number of slices is larger than 4. 

     \ttitem{COLLIM} is the default slicing for collimators. If only
     one slice is  chosen it is placed in the middle of the old
     element. If two slices are chosen they  are placed at either
     end. Three slices or more are treated as one slice.      

     \ttitem{TEAPOT} is the improved slicing algorithm described in
     \href{../Introduction/bibliography.html#TEAPOT}{[TEAPOT]} and
     generalized to any number of slices. \\
     It is the default if the number of slice is less or equal to 4.

     \ttitem{(option not given)} The standard default slicing for all
     elements (except collimators). It uses {\tt TEAPOT} if the number
     of slices is less or equal to 4, and {\tt SIMPLE} otherwise.
     \end{madlist}
     
   \ttitem{MINIMIZEPARENTS} to be documented
   \ttitem{MAKECONSISTENT} to be documented
   \ttitem{MAKEDIPEDGE} to be documented
\end{madlist}


\textbf{Note:} It is strongly recommended to always specify {\tt STYLE=teapot}  
to use the improved slicing for any number of slices.


%% \textbf{By default} all elements are converted to one thin element
%% positioned at the center of the thick element that they replace. 
%% To get more slices for certain elements, one can use a standard SELECT
%% command with FLAG=MAKETHIN and CLASS, RANGE or PATTERN selections:  

%% \begin{verbatim}
%% SELECT,FLAG=MAKETHIN,
%%        CLASS=class,RANGE=range, PATTERN=pattern,
%%        SLICE=no_of_slices;
%% \end{verbatim}

The number of slices can be set individually for elements or groups of
elements using
\href{http://mad.web.cern.ch/mad/madx.old/Introduction/select.html}{select}
commands
\begin{verbatim}
SELECT, FLAG=makethin, 
        RANGE=range, CLASS=class, PATTERN=pattern[,FULL][,CLEAR],
        THICK=logical, SLICE=integer;
\end{verbatim}

where the argument to the parameter {\tt SLICE} stands for the number of
slices for the selected elements. The default is one slice and
THICK=false for all elements, i.e. conversion of all thick elements to a
single thin slice positioned at the centre of the original thick
element.

{\bf Restrictions:}
\begin{itemize}
\item makethin requires that the sequence makes use of the default
  positioning of elements ({\tt REFER=centre}). 
\item {\tt THICK=true} only applies to dipole or quadrupole magnet
  elements and is ignored otherwise.  
\end{itemize}


The generated thin lens sequence has the following properties: 
\begin{itemize}
\item The new sequence has the same name as the original. The original sequence
  is replaced by the new one in memory. If the original sequence is
  needed for further processing in MAD-X, it should be reloaded.
\item The algorithm also slices any sub-sequence inserted in the main
  sequence. These sub-sequences are also given the same names as the originals. 
\item Any element transformed into a single thin lens element has the
  same name as the original. 
\item If an element is sliced into more than one slice, the individual
  slices have the same basename as the original element plus a suffix 
  {\tt ..1}, {\tt ..2}, etc. and a marker, with the name of the original
  element, is placed at the location of the center of the original element.
\end{itemize}



Hints: 
\begin{itemize}
   \item See the
     \href{http://cern.ch/frs/mad-X_examples/makethin/}{examples} for
     makethin.  
   \item Compare the optics before and after slicing with
     makethin. Consider to increase the number of slices and rematch
     after makethin to \textbf{reach the required accuracy}.  
   \item Consider to replace rbend by sbend + thin quads taking into
     account the edge focusing before slicing with makethin.  
   \item The selection works on the current sequence. Consider to insert
     a "USE,SEQUENCE=.." before SELECT  
\end{itemize}


{\large{\bf Enhanced options}, implemented in 2013}
\begin{itemize}
\item Slicing can be turned off for certain elements or classes by specifying
a number of slices $< 1$. Examples:
\begin{verbatim}
! turn off slicing for sextupoles
select, flag=makethin, class=sextupole, slice=0; 

! keep elements unchanged with names starting by mbxw
select, flag=makethin, pattern=mbxw\., slice=0; 
\end{verbatim}

This option allows to introduce slicing step by step and monitor the
resulting changes in optics parameters.
%Note that subsequent tracking generally requires full slicing, with possible exception of quadrupoles and bending magents.

\item {\bf Thick quadrupole slices:}
Makethin has been upgraded in 2013 to allow for thick quadrupole slicing
with insertion of markers between thick slices. 
Positioning is done with markers between slices, here however with thick
slice quadrupole piece filling the whole length. 
Examples:
\begin{verbatim}
! slice quadrupoles thick, insert 2 markers per quadrupole
select, flag=makethin, class=quadrupole, thick=true, slice=2; 

! thick slicing for quadrupoles named mqxa, insert one marker in the middle
select, flag=makethin, pattern=mqxa\., slice=1,  thick=true; 
\end{verbatim}

\item {\bf Automatic dipedge generation for bending magnets:}
Makethin has been upgraded in 2013 to automatically generated dipedges
at the start and/or end of bending magnets, to conserve edge focusing
from pole face angles {\tt e1}, {\tt e2} or extra fields described by
{\tt fint}, {\tt fintx}, in the slicing of bending magnets to thin
multipole slices. 
Selection with {\tt THICK=true} will translate a complex thick {\tt
  rbend} or {\tt sbend} including edge effects to a simple thick
sbend in which the edge focusing is transferred to extra
dipedges. 
Example:
\begin{verbatim}
!  keep translated rbend as thick sbend
select, flag=makethin, rbend, thick=true;
\end{verbatim}
\end{itemize}


{\bf Hints}\\
% Makethin should be considered as a tool to automatically translate a
% thick sequence as relevant for matching and twiss, into a sequence
% which can be used as input for tracking. The  
\begin{enumerate}
\item Compare the main optics parameters like tunes before and after slicing
with makethin. 
\item In tests, turn off slicing for some of the main element classes to
identify the main sources of changes. 
\item For sextuples and octupoles, a single slice should always be sufficient.
\item Increase the number of slices for critical elements like mini-beta
quadrupoles. Even there, more than four slices should rarely be
required. 
\item Rematch tunes and chromaticity after makethin. 
\end{enumerate}


See the
\href{http://madx.web.cern.ch/madx/madX/examples/makethin/}{examples}
for makethin.

See also the presentations on the upgrade of the makethin module,\\
\href{http://ab-dep-abp.web.cern.ch/ab-dep-abp/LCU/LCU_meetings/2012/20120918/LCU_makethin_2012_09_18.pdf}{LCU\_makethin\_2012\_09\_18.pdf}, 
\hspace{0.2cm} 
\href{http://ab-dep-abp.web.cern.ch/ab-dep-abp/LCU/LCU_meetings/2013/20130419/LCU_makethin_2013_04_19.pdf}{LCU\_makethin\_2013\_04\_19.pdf}.
 

TEAPOT is documented in \href{http://accelconf.web.cern.ch/AccelConf/IPAC2013/papers/mopwo027.pdf}{IPAC'13 MOPWO027}

%%%%%%%%










