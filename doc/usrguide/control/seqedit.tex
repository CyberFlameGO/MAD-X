%%%\title{Sequence Editor}
%  Changed by: Chris ISELIN, 24-Feb-1998 
%  Changed by: Hans Grote, 17-Jun-2002 

\chapter{Sequence Editor}
\label{chap:seqedit}
With the help of the commands explained below, a sequence may be
modified in many ways: the starting point can be moved to another place;
the order of elements can be inverted; elements can be inserted one by
one, or as a whole group with one single command; single elements, or
classes thereof can be removed; elements can be replaced by others;
finally, the sequence can be "flattened", i.e. all inserted sequences
are replaced by their actual elements, such that a flattened sequence
contains only elements. It is good practice to add a \textit{ flatten; }
statement at the end of a \textit{ seqedit operation } to ensure a fully
operational sequence. And this is particularly useful for the \textit{
  save } command to properly save \textit{ shared sequences } and to
write out in \textit{ MAD-8 } format.  

%% 2013-Jul-11  17:35:46  ghislain: need a synopsis paragraph similar to
%% what PTC offers and a complement of a few examples using all commands
%% shown here...

\section{SEQEDIT}
\label{sec:seqedit}
\begin{verbatim}
seqedit, sequence=s_name;
\end{verbatim} 
selects the sequence named for editing. The editing is performed on the
non-expanded sequence; after having finished the editing, one has to
re-expand the sequence if necessary.  

\section{EXTRACT}
\label{sec:extract}
\begin{verbatim}
extract, sequence=s_name, from=MARKER_1, to=MARKER_2, newname=p;
\end{verbatim} 
A new sequence with name "p" is extracted from the existing sequence named "s\_name", 
starting from MARKER\_1 and ending at MARKER\_2. The new sequence
"p" can be USEd as any other sequence. It is declared as "shared" and
can therefore be combined e.g. into the cycled original sequence. \\ 
Note that MARKER\_1 must be located before MARKER\_2 in the existing sequence "s\_name", 
or MAD-X will fail with a fatal error. 
In the case of circular sequences, this can be ensured by performing a CYCLE 
of sequence "s\_name" with {\tt START=MARKER\_1}.

\section{FLATTEN}
\label{sec:flatten}
\begin{verbatim}
flatten;
\end{verbatim} 
This command includes all sequences in the sequence being edited, if
any. The resulting sequence contains only elements.  

\section{INSTALL}
\label{sec:install}
\begin{verbatim}
install, element=name, class=class_name, at=real, from=place|selected;
\end{verbatim} 
where the parameters have the following meaning: 
\begin{itemize}
   \item element: name of the (new) element to be inserted (mandatory) 
   \item class: class of the new element to be inserted (mandatory) 
   \item at: position where the element is to be inserted; if no "from"
     is given,this is relative to the start of the sequence. If "from"
     is given, it is relative to the position specified there. 
   \item from:either a place (i.e. the name(+occurrence count) of an
     element already existing in the sequence, e.g. mb[15], or
     mq.a..i1..4 etc.; or the string "selected"; in this latter case an
     element of the type specified will be inserted behind all elements
     in the sequence that are currently selected by one or several
     \href{../Introduction/select.html}{SELECT} commands of the type 
\begin{verbatim}
select, flag=seqedit, class=.., pattern=.., range=..;
\end{verbatim} 
   \item \textit{ Attention: No element definitions inside seqedit. }
\end{itemize}

\section{MOVE}
\label{sec:move}
\begin{verbatim}
move, element=name|selected, by=real, to=real, from=place;
\end{verbatim}
\begin{itemize}
   \item element: name of the existing element to be moved, or
     "selected", in which case all elements from existing
     \href{../Introduction/select.html}{SELECT} commands will be moved;
     in the latter case, "by" must be given.  
   \item by: amount by which the element(s) is/are to be moved; no "to"
     nor "from" in this case.  
   \item to: position to which the element has to be moved; if no from,
     then this is relative to the start of the sequence; otherwise, it
     is relative to the place given in "from".  
   \item from: place in the sequence with respect to which the element
     is to be positioned.  
\end{itemize}

\section{REMOVE}
\label{sec:remove}
\begin{verbatim}
remove, element=name|selected;
\end{verbatim}
\begin{itemize}
   \item element: name of the existing element to be removed, or
     "selected", in which case all elements from existing
     \href{../Introduction/select.html}{SELECT} commands will be
     removed. 
   \item \textit{Attention: It is a bad idea to remove all markers from
     a sequence! In particular the "start=" marker and the new markers
     added by "cycle" must never be removed from a sequence.} 
\end{itemize}

\section{CYCLE}
\label{sec:cycle}
\begin{verbatim}
cycle, start=place;
\end{verbatim} 
This makes the sequence start at the place given, which must be a
marker. \\ 
In the case there is a shared sequence in the used sequence, the
command FLATTEN has to be used before the command CYCLE. Example:  
\begin{verbatim}
flatten ; cycle, start=place; 
\end{verbatim}

\section{REFLECT}
\label{sec:reflect}
\begin{verbatim}
reflect;
\end{verbatim} 
This inverts the order of element in the sequence, starting from the
last element. \\ 
If there are shared sequences inside the USEd sequence, the command
FLATTEN must be used before the command REFLECT.  Alternatively each
shared sequence must first be reflected. Example:   
\begin{verbatim}
flatten ; reflect; 
\end{verbatim}


\section{REPLACE}
\label{sec:replace}
\begin{verbatim}
replace, element=name1|selected, by=name2;
\end{verbatim} 
Element with name1 is replaced by element with name2. 
If name1 is "selected", then all elements selected by
\href{../Introduction/select.html}{SELECT} commands will be replaced by
the element name2.  


\section{ENDEDIT}
\label{sec:endedit}
\begin{verbatim}
endedit;
\end{verbatim} 
terminates the sequence editing process. The nodes in the sequence are
renumbered according to their occurrence which might have changed during
editing.  



\section{SAVE}
\label{sec:save}
\begin{verbatim}
save, sequence = sequ1, sequ2, ..., file = "file_name", beam, bare;
\end{verbatim} 
saves the sequence(s) specified with all variables and elements needed
for their expansion, onto the file "file\_name". 

{\bf Warning:} If quotes are used for
the "file\_name", capital and low characters are kept as specified, if they
are omitted the "filename" will have lower characters only. 

Example:
\begin{verbatim}
save, sequence = lhc, file = "Test_One";
\end{verbatim}
saves the lhc sequence to a file name Test\_One on disk, while
\begin{verbatim}
save, sequence = lhc, file = Test_One;
\end{verbatim}
saves the lhc sequence to a file name test\_one on disk.

The optional
flag can have the value "mad8" (without the quotes), in which case the
sequence(s) is/are saved in MAD-8 input format.  

The flag "beam" is optional; when given, all beams belonging to the
sequences specified are saved at the top of the save file.  

The parameter "sequence" is optional; when omitted, all sequences are
saved.  

However, it is not advisable to use "save" without the "sequence" option
unless you know what you are doing. This practice will avoid spurious
saved entries.    Any number of "select,flag=save" commands may precede
the SAVE command. In that case, the names of elements, variables, and
sequences must match the pattern(s) if given, and in addition the
elements must be of the class(es) specified. See here for a
\href{../Introduction/select.html#save_select}{SAVE with SELECT}
example.  

It is important to note that the precision of the output of the save
command depends on the output precision. Details about default
precisions and how to adjust those precisions can be found at the
\href{../Introduction/set.html#Format}{SET Format} instruction page.   
 
The attribute 'bare' allows to save just the sequence without the
element definitions nor beam information. This allows to re-read in a
sequence with might otherwise create a stop of the program. This is
particularly useful to turn a line into a sequence to seqedit
it. 

Example:  
\begin{verbatim}
tl3:line=(ldl6,qtl301,mqn,qtl301,ldl7,qtl302,mqn,qtl302,ldl8,ison);
DLTL3 : LINE=(delay, tl3);
use, period=dltl3;

save,sequence=dltl3,file=t1,bare; // new parameter "bare": only sequ. saved
call,file=t1; // sequence is read in and is now a "real" sequence
// if the two preceding lines are suppressed, seqedit will print a warning
// and else do nothing
use, period=dltl3;
twiss, save, betx=bxa, alfx=alfxa, bety=bya, alfy=alfya;
plot, vaxis=betx, bety, haxis=s, colour:=100;
SEQEDIT, SEQUENCE=dltl3;
  remove,element=cx.bhe0330;
  remove,element=cd.bhe0330;
ENDEDIT;

use, period=dltl3;
twiss, save, betx=bxa, alfx=alfxa, bety=bya, alfy=alfya;
\end{verbatim}

%% 2013-Jul-11  17:24:21  ghislain: I propose to move DUMPSEQU to the
%% sequence edition and manipulation part of the manual
\section{DUMPSEQU}
\label{sec:dumpsequ}
\begin{verbatim}
dumpsequ, sequence = s_name, level = integer;
\end{verbatim} 
Actually a debug statement, but it may come handy at certain
occasions. Here "s\_name" is the name of an expanded (i.e. USEd)
sequence. The amount of detail is controlled by "level":  
\begin{verbatim}
level = 0:    print only the cumulative node length = sequence length
      > 0:    print all node (element) names except drifts
      > 2:    print all nodes with their attached parameters
      > 3:    print all nodes, and their elements with all parameters
\end{verbatim}



%% EOF
