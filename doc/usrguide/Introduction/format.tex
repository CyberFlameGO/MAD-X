%%\title{Command Format}
%  Changed by: Chris ISELIN, 24-Jan-1997 
%  Changed by: Hans Grote, 25-Sep-2002 
%  Changed by: Ghislain ROY, 27-Jan-2014 

\chapter{Command Format}


\section{Statements and Comments}

\subsection{Input Statements}
Input for \madx follows in broad lines the
\href{http://cern.ch/mad9}{\madnine}\index{MAD-9} format, i.e. free format
with commas (,) as separators, although blanks may be used as separators
outside \{...\} enclosures.  
Blank input lines do not affect program execution. 
The input is not case sensitive except for strings enclosed in double
quotes (" "). 

The input file consists of a sequence of commands, also known as
statements. A statement must be terminated by a semicolon (;).
A statement may occupy any number of input lines. 
Several statements may be placed on the same line.

By exception if a statement contains a block of
statements, the terminating semmicolon can be omitted, as in the
following example: 
\begin{verbatim}
if (a < 3) {a=b^2; b=2*b+4;}
\end{verbatim}

\subsection{Comments}
When an exclamation mark ({\tt !}) or double forward slash ({\tt //}) is
found in the input line, the remaining characters until the end of the
line are treated as a comment and are skipped. 

A comment spreading over multiple lines starts with a "/*" and ends with a "*/".

\subsection{Commands}
The general format for a command is 
\begin{verbatim}
label: keyword {,attribute} ;
\end{verbatim}
where the  {\tt \{ \}} are not part of the command and the items
enclosed in {\tt \{ \}} can be omitted or repeated any number of times. 


A command contains three parts:
\begin{madlist}
   \ttitem{label}\index{label} 
   A \href{label.html}{label} is required for a definition statement. 
   It gives a name to the stored command.
     
   \ttitem{keyword}\index{keyword} 
   A \href{keyword.html}{keyword} identifies the action desired.
     
   \ttitem{attributes}\index{attribute} 
   The \href{attribute.html}{attributes} are normally entered in the
   form \\
   {\tt attribute-name = attribute-value} \\
   and serve to define data for the command, where:
   \begin{madlist}
       \ttitem{attribute-name} selects the attribute, and
       \ttitem{attribute-value} provides its value.       
     \end{madlist}
\end{madlist}

If a value is to be assigned to an attribute, the {\tt attribute-name} is
mandatory.

Whenever an attribute is not explicitely given a value, the default 
{\tt attribute-value} specified in the command dictionnary is assumed. 

In the case of attributes taking logical values, it is sufficient to
enter the {\tt attribute-name} only; the attribute is then given the
default {\tt attribute-value} specified in the command dictionary.

Example: {\tt TILT} attribute for various magnets.

The command attributes can have one of the following types:
\begin{itemize}
  \item \href{string.html}{String attribute},
  \item \href{logical.html}{Logical attribute},
  \item \href{integer.html}{Integer attribute},
  \item \href{real.html}{Real attribute},
  \item \href{expression.html}{Expression},
  \item \href{select.html}{Range selection},
\end{itemize}

Any integer or real attribute can be replaced by
a \href{expression.html}{real expression}; expressions are
normally deferred\index{deferred} 
(see \href{expression.html#defer}{deferred expression}), except in the  
definition of constants where they are evaluated immediately.

When a command has a \href{label.html}{label}, \madx keeps this command
in memory. This allows repeated execution of the same command
by just entering EXEC label. This construct may be nested.

For an exhaustive list of valid declarations of constants or variables
see \href{declarations.html}{declarations}.


% add other files to the end of this file

%\input{Introduction/keyword}
\subsection{Keywords}
\label{subsec:keyword}

A keyword begins with a letter and consists of letters and digits. 

The \madx keywords are protected; using one of them as a label results
in a fatal error.   

%\input{Introduction/declarations}
\subsection{Variable Declarations}
\label{subsec:var_declarations}

In the following, "=" means that the variable at the left receives the
current value of the expression at right, but does not depend on it any
further, whereas ":=" makes it depend on this expression, i.e. every
time the expression changes, the variable is re-evaluated, except for
"const" variables.  

\begin{verbatim}
var = expression;
var := expression;
real var = expression;        // identical
real var := expression;       // to above
int var = expression;         // truncated if expression is real
int var := expression;
const var = expression;
const var := expression;
const real var = expression;        // identical
const real var := expression;       // to above
const int var = expression;         // truncated if expression is real
const int var := expression;
\end{verbatim}

%\input{Introduction/select}
%% This section was mostly redundant with one in Chapter 4, Section 2 (General
%% Control Statements) and was moved there.
%% \subsection{Selection Statements}
%% \label{subsec:selection}

%% The elements, or a range of elements, in a sequence can be selected for
%% various purposes. Such selections remain valid until cleared (in
%% difference to MAD-8); it is therefore recommended to always start with a  

%% \begin{verbatim}
%% select, flag =..., clear;
%% \end{verbatim} 
%% before setting a new selection. 
%% \begin{verbatim}
%% SELECT, FLAG=name, RANGE=range, CLASS=class, PATTERN=pattern [,FULL] [,CLEAR];
%% \end{verbatim} 
%% where the name for FLAG can be one of ERROR, MAKETHIN, SEQEDIT or the
%% name of a twiss table which is established for all sequence positions in
%% general.  

%% Selected elements have to fulfill the \href{ranges.html#range}{RANGE},
%% \href{ranges.html#class}{CLASS}, and \href{wildcard.html}{PATTERN}
%% criteria.  

%% Any number of SELECT commands can be issued for the same flag and are
%% accumulated (logically ORed). In this context note the following:  

%% \begin{verbatim}
%% SELECT, FLAG=name, FULL;
%% \end{verbatim} 
%% selects all positions in the sequence for this flag. This is the default
%% for all tables and makethin, whereas for ERROR and SEQEDIT the default
%% is "nothing selected".  

%% %\href{save_select}{}
%% \label{save_select}
%% SAVE: A SELECT,FLAG=SAVE statement causes the
%% selected sequences, elements, and variables to be written into the save
%% file. A class (only used for element selection), and a pattern can be
%% specified. Example:  
%% \begin{verbatim}
%% select, flag=save, class=variable, pattern="abc.*";
%% save, file=mysave;
%% \end{verbatim} 
%% will save all variables (and sequences) containing "abc" in their name,
%% but not elements with names containing "abc" since the class "variable"
%% does not exist (astucieux, non ?).  

%% SECTORMAP: A SELECT,FLAG=SECTORMAP statement causes sectormaps to be
%% written into the file "sectormap" like in MAD-8. For the file to be
%% written, a flag SECTORMAP must be issued on the TWISS command in
%% addition.  

%% TWISS: A SELECT,FLAG=TWISS statement causes the selected rows and
%% columns to be written into the Twiss TFS file (former OPTICS command in
%% MAD-8). The column selection is done on the same select. See as well
%% example 2.  

%% Example 1:  
%% \begin{verbatim}
%% TITLE,'Test input for MAD-X';

%% option,rbarc=false; // use arc length of rbends
%% beam; ! sets the default beam for the following sequence
%% option,-echo;
%% call file=fv9.opt;  ! contains optics parameters
%% call file="fv9.seq"; ! contains a small sequence "fivecell"
%% OPTION,ECHO;
%% SELECT,FLAG=SECTORMAP,clear;
%% SELECT,FLAG=SECTORMAP,PATTERN="^m.*";
%% SELECT,FLAG=TWISS,clear;
%% SELECT,FLAG=TWISS,PATTERN="^m.*",column=name,s,betx,bety;
%% USE,PERIOD=FIVECELL;
%% twiss,file=optics,sectormap;
%% stop;
%% \end{verbatim} 

%% This produces a file \href{sectormap.html}{sectormap}, and a
%% twiss output file \label{tfs} (name = optics):  
%% \begin{verbatim}
%% @ TYPE             %05s "TWISS"
%% @ PARTICLE         %08s "POSITRON"
%% @ MASS             %le          0.000510998902
%% @ CHARGE           %le                       1
%% @ E0               %le                       1
%% @ PC               %le           0.99999986944
%% @ GAMMA            %le           1956.95136738
%% @ KBUNCH           %le                       1
%% @ NPART            %le                       0
%% @ EX               %le                       1
%% @ EY               %le                       1
%% @ ET               %le                       0
%% @ LENGTH           %le                   534.6
%% @ ALFA             %le        0.00044339992938
%% @ ORBIT5           %le                      -0
%% @ GAMMATR          %le           47.4900022541
%% @ Q1               %le           1.25413071556
%% @ Q2               %le           1.25485338377
%% @ DQ1              %le           1.05329608302
%% @ DQ2              %le           1.04837000224
%% @ DXMAX            %le           2.17763211131
%% @ DYMAX            %le                       0
%% @ XCOMAX           %le                       0
%% @ YCOMAX           %le                       0
%% @ BETXMAX          %le            177.70993499
%% @ BETYMAX          %le           177.671582415
%% @ XCORMS           %le                       0
%% @ YCORMS           %le                       0
%% @ DXRMS            %le           1.66004270906
%% @ DYRMS            %le                       0
%% @ DELTAP           %le                       0
%% @ TITLE            %20s "Test input for MAD-X"
%% @ ORIGIN           %16s "MAD-X 0.20 Linux"
%% @ DATE             %08s "07/06/02"
%% @ TIME             %08s "14.25.51"
%% * NAME               S                  BETX               BETY               
%% $ %s                 %le                %le                %le                
%%  "MSCBH"             4.365              171.6688159        33.31817319       
%%  "MB"                19.72              108.1309095        58.58680717       
%%  "MB"                35.38              61.96499987        102.9962313       
%%  "MB"                51.04              34.61640793        166.2227523       
%%  "MSCBV.1"           57.825             33.34442808        171.6309057       
%%  "MB"                73.18              58.61984637        108.0956006       
%%  "MB"                88.84              103.0313887        61.93159422       
%%  "MB"                104.5              166.2602486        34.58939635       
%%  "MSCBH"             111.285            171.6688159        33.31817319       
%%  "MB"                126.64             108.1309095        58.58680717       
%%  "MB"                142.3              61.96499987        102.9962313       
%%  "MB"                157.96             34.61640793        166.2227523       
%%  "MSCBV"             164.745            33.34442808        171.6309057       
%%  "MB"                180.1              58.61984637        108.0956006       
%%  "MB"                195.76             103.0313887        61.93159422       
%%  "MB"                211.42             166.2602486        34.58939635       
%%  "MSCBH"             218.205            171.6688159        33.31817319       
%%  "MB"                233.56             108.1309095        58.58680717       
%%  "MB"                249.22             61.96499987        102.9962313       
%%  "MB"                264.88             34.61640793        166.2227523       
%%  "MSCBV"             271.665            33.34442808        171.6309057       
%%  "MB"                287.02             58.61984637        108.0956006       
%%  "MB"                302.68             103.0313887        61.93159422       
%%  "MB"                318.34             166.2602486        34.58939635       
%%  "MSCBH"             325.125            171.6688159        33.31817319       
%%  "MB"                340.48             108.1309095        58.58680717       
%%  "MB"                356.14             61.96499987        102.9962313       
%%  "MB"                371.8              34.61640793        166.2227523       
%%  "MSCBV"             378.585            33.34442808        171.6309057       
%%  "MB"                393.94             58.61984637        108.0956006       
%%  "MB"                409.6              103.0313887        61.93159422       
%%  "MB"                425.26             166.2602486        34.58939635       
%%  "MSCBH"             432.045            171.6688159        33.31817319       
%%  "MB"                447.4              108.1309095        58.58680717       
%%  "MB"                463.06             61.96499987        102.9962313       
%%  "MB"                478.72             34.61640793        166.2227523       
%%  "MSCBV"             485.505            33.34442808        171.6309057       
%%  "MB"                500.86             58.61984637        108.0956006       
%%  "MB"                516.52             103.0313887        61.93159422       
%%  "MB"                532.18             166.2602486        34.58939635       
%% \end{verbatim}

%%  Example 2: 

%%  Addition of variables to (any internal) table: 
%% \begin{verbatim}
%% select, flag=table, column=name, s, betx, ..., var1, var2, ...; ! or
%% select, flag=table, full, column=var1, var2, ...; ! default col.s + new
%% \end{verbatim} 
%% will write the current value of var1 etc. into the table each time a new
%% line is added; values from the same (current) line can be accessed by
%% these variables, e.g.  
%% \begin{verbatim}
%% var1 := sqrt(beam->ex*table(twiss,betx));
%% \end{verbatim} 
%% in the case of table above being "twiss". The plot command accepts the
%% new variables.  

%% Remark: this replaces the "string" variables of MAD-8. 

%%  This example demonstrates as well the usage of a user defined table \label{ucreate}. 
%% \begin{verbatim}
%% beam,ex=1.e-6,ey=1.e-3;
%% // element definitions
%% mb:rbend, l=14.2, angle:=0,k0:=bang/14.2;
%% mq:quadrupole, l:=3.1,apertype=ellipse,aperture={1,2};
%% qft:mq, l:=0.31, k1:=kqf,tilt=-pi/4;
%% qf.1:mq, l:=3.1, k1:=kqf;
%% qf.2:mq, l:=3.1, k1:=kqf;
%% qf.3:mq, l:=3.1, k1:=kqf;
%% qf.4:mq, l:=3.1, k1:=kqf;
%% qf.5:mq, l:=3.1, k1:=kqf;
%% qd.1:mq, l:=3.1, k1:=kqd;
%% qd.2:mq, l:=3.1, k1:=kqd;
%% qd.3:mq, l:=3.1, k1:=kqd;
%% qd.4:mq, l:=3.1, k1:=kqd;
%% qd.5:mq, l:=3.1, k1:=kqd;
%% bph:hmonitor, l:=l.bpm;
%% bpv:vmonitor, l:=l.bpm;
%% cbh:hkicker;
%% cbv:vkicker;
%% cbh.1:cbh, kick:=acbh1;
%% cbh.2:cbh, kick:=acbh2;
%% cbh.3:cbh, kick:=acbh3;
%% cbh.4:cbh, kick:=acbh4;
%% cbh.5:cbh, kick:=acbh5;
%% cbv.1:cbv, kick:=acbv1;
%% cbv.2:cbv, kick:=acbv2;
%% cbv.3:cbv, kick:=acbv3;
%% cbv.4:cbv, kick:=acbv4;
%% cbv.5:cbv, kick:=acbv5;
%% !mscbh:sextupole, l:=1.1, k2:=ksf;
%% mscbh:multipole, knl:={0,0,0,ksf},tilt=-pi/8;
%% mscbv:sextupole, l:=1.1, k2:=ksd;
%% !mscbv:octupole, l:=1.1, k3:=ksd,tilt=-pi/8;

%% // sequence declaration

%% fivecell:sequence, refer=centre, l=534.6;
%%    qf.1:qf.1, at=1.550000e+00;
%%    qft:qft, at=3.815000e+00;
%% !   mscbh:mscbh, at=3.815000e+00;
%%    cbh.1:cbh.1, at=4.365000e+00;
%%    mb:mb, at=1.262000e+01;
%%    mb:mb, at=2.828000e+01;
%%    mb:mb, at=4.394000e+01;
%%    bpv:bpv, at=5.246000e+01;
%%    qd.1:qd.1, at=5.501000e+01;
%%    mscbv:mscbv, at=5.727500e+01;
%%    cbv.1:cbv.1, at=5.782500e+01;
%%    mb:mb, at=6.608000e+01;
%%    mb:mb, at=8.174000e+01;
%%    mb:mb, at=9.740000e+01;
%%    bph:bph, at=1.059200e+02;
%%    qf.2:qf.2, at=1.084700e+02;
%%    mscbh:mscbh, at=1.107350e+02;
%%    cbh.2:cbh.2, at=1.112850e+02;
%%    mb:mb, at=1.195400e+02;
%%    mb:mb, at=1.352000e+02;
%%    mb:mb, at=1.508600e+02;
%%    bpv:bpv, at=1.593800e+02;
%%    qd.2:qd.2, at=1.619300e+02;
%%    mscbv:mscbv, at=1.641950e+02;
%%    cbv.2:cbv.2, at=1.647450e+02;
%%    mb:mb, at=1.730000e+02;
%%    mb:mb, at=1.886600e+02;
%%    mb:mb, at=2.043200e+02;
%%    bph:bph, at=2.128400e+02;
%%    qf.3:qf.3, at=2.153900e+02;
%%    mscbh:mscbh, at=2.176550e+02;
%%    cbh.3:cbh.3, at=2.182050e+02;
%%    mb:mb, at=2.264600e+02;
%%    mb:mb, at=2.421200e+02;
%%    mb:mb, at=2.577800e+02;
%%    bpv:bpv, at=2.663000e+02;
%%    qd.3:qd.3, at=2.688500e+02;
%%    mscbv:mscbv, at=2.711150e+02;
%%    cbv.3:cbv.3, at=2.716650e+02;
%%    mb:mb, at=2.799200e+02;
%%    mb:mb, at=2.955800e+02;
%%    mb:mb, at=3.112400e+02;
%%    bph:bph, at=3.197600e+02;
%%    qf.4:qf.4, at=3.223100e+02;
%%    mscbh:mscbh, at=3.245750e+02;
%%    cbh.4:cbh.4, at=3.251250e+02;
%%    mb:mb, at=3.333800e+02;
%%    mb:mb, at=3.490400e+02;
%%    mb:mb, at=3.647000e+02;
%%    bpv:bpv, at=3.732200e+02;
%%    qd.4:qd.4, at=3.757700e+02;
%%    mscbv:mscbv, at=3.780350e+02;
%%    cbv.4:cbv.4, at=3.785850e+02;
%%    mb:mb, at=3.868400e+02;
%%    mb:mb, at=4.025000e+02;
%%    mb:mb, at=4.181600e+02;
%%    bph:bph, at=4.266800e+02;
%%    qf.5:qf.5, at=4.292300e+02;
%%    mscbh:mscbh, at=4.314950e+02;
%%    cbh.5:cbh.5, at=4.320450e+02;
%%    mb:mb, at=4.403000e+02;
%%    mb:mb, at=4.559600e+02;
%%    mb:mb, at=4.716200e+02;
%%    bpv:bpv, at=4.801400e+02;
%%    qd.5:qd.5, at=4.826900e+02;
%%    mscbv:mscbv, at=4.849550e+02;
%%    cbv.5:cbv.5, at=4.855050e+02;
%%    mb:mb, at=4.937600e+02;
%%    mb:mb, at=5.094200e+02;
%%    mb:mb, at=5.250800e+02;
%%    bph:bph, at=5.336000e+02;
%% end:marker, at=5.346000e+02;
%% endsequence;

%% // forces and other constants

%% l.bpm:=.3;
%% bang:=.509998807401e-2;
%% kqf:=.872651312e-2;
%% kqd:=-.872777242e-2;
%% ksf:=.0198492943;
%% ksd:=-.039621283;
%% acbv1:=1.e-4;
%% acbh1:=1.e-4;
%% !save,sequence=fivecell,file,mad8;

%% s := table(twiss,bpv[5],betx);
%% myvar := sqrt(beam->ex*table(twiss,betx));
%% use, period=fivecell;
%% select,flag=twiss,column=name,s,myvar,apertype;
%% twiss,file;
%% n = 0;
%% create,table=mytab,column=dp,mq1,mq2;
%% mq1:=table(summ,q1);
%% mq2:=table(summ,q2);
%% while ( n < 11)
%% {
%%   n = n + 1;
%%   dp = 1.e-4*(n-6);
%%   twiss,deltap=dp;
%%   fill,table=mytab;
%% }
%% write,table=mytab;
%% plot,haxis=s,vaxis=aper_1,aper_2,colour=100,range=#s/cbv.1,notitle;
%% stop;
%% \end{verbatim}
%% prints the following user table on output:

%% \begin{verbatim}
%% @ NAME             %05s "MYTAB"
%% @ TYPE             %04s "USER"
%% @ TITLE            %08s "no-title"
%% @ ORIGIN           %16s "MAD-X 1.09 Linux"
%% @ DATE             %08s "10/12/02"
%% @ TIME             %08s "10.45.25"
%% * DP                 MQ1                MQ2                
%% $ %le                %le                %le                
%%  -0.0005            1.242535951        1.270211135       
%%  -0.0004            1.242495534        1.270197018       
%%  -0.0003            1.242452432        1.270185673       
%%  -0.0002            1.242406653        1.270177093       
%%  -0.0001            1.242358206        1.270171269       
%%  0                  1.242307102        1.27016819        
%%  0.0001             1.242253353        1.270167843       
%%  0.0002             1.242196974        1.270170214       
%%  0.0003             1.24213798         1.270175288       
%%  0.0004             1.242076387        1.270183048       
%%  0.0005             1.242012214        1.270193477       
%% \end{verbatim}
%% and produces a twiss file with the additional column myvar, as well as a plot
%% file with the aperture values plotted.


%% \href{screate}{}

%% Example of joining two tables with different length into a third table
%% making use of the length of either table as given by
%% table("your\_table\_name", tablelength) and adding names by the "\_name"
%% attribute.

%% \begin{verbatim}
%% title,   "summing of offset and alignment tables";
%% set,    format="13.6f";

%% readtable, table=align,  file="align.ip2.b1.tfs";   // mesured alignment
%% readtable, table=offset, file="offset.ip2.b1.tfs";  // nominal offsets

%% n_elem  =  table(offset, tablelength);

%% create,  table=align_offset, column=_name,s_ip,x_off,dx_off,ddx_off,y_off,dy_off,ddy_off;

%% calcul(elem_name) : macro = {
%%     x_off = table(align,  elem_name, x_ali) + x_off;
%%     y_off = table(align,  elem_name, y_ali) + y_off;
%% }


%% one_elem(j_elem) : macro = {
%%     setvars, table=offset, row=j_elem;
%%     exec,  calcul(tabstring(offset, name, j_elem));
%%     fill,  table=align_offset;
%% }


%% i_elem = 0;
%% while (i_elem < n_elem) { i_elem = i_elem + 1; exec,  one_elem($i_elem); }

%% write, table=align_offset, file="align_offset.tfs";

%% stop;
%% \end{verbatim}

%\input{Introduction/set}
%% This section was redundant with one in Chapter 4, Section 2 (General
%% Control Statements)
%% \subsection{Set Statements}

%% \begin{verbatim}
%% set, format="...", sequence="...";
%% \end{verbatim} 

%% The set command allows 2 actions: 

%% \subsubsection{1) Format} 
%% The first command lets you vary the output precision. 
%% \begin{verbatim}
%% parameter: format = s1, s2, s3
%% \end{verbatim} 
%% (up to) three strings defining the integer, floating, and string output
%% format for the save, show, value, and table output. The formats can be
%% given in any order and stay valid until replaced. The defaults are:  
%% \begin{verbatim}
%% "10d","18.10g","-18s".
%% \end{verbatim} 
%% They follow the C convention. The quotes are mandatory. The allowed formats are: 
%% \begin{verbatim}
%% "nd" for integer with n = field width.
%% \end{verbatim}
%% \begin{verbatim}
%% "m.nf" or "m.ng" or "m.ne" for floating, m field width, n precision.
%% \end{verbatim}
%% \begin{verbatim}
%% "ns" for string output.
%% \end{verbatim} 
%% The default is "right adjusted", a "-" changes it to "left adjusted".  Example: 
%% \begin{verbatim}
%% set,format="22.14e";
%% \end{verbatim} 
%% changes the current floating point format to 22.14e; the other formats remain untouched. 
%% \begin{verbatim}
%% set,format="s","d","g";
%% \end{verbatim} 
%% sets all formats to automatic adjustment according to C conventions. 

%% \subsubsection{2) Sequence} The second command lets you choose the
%% current sequence without having to use the "USE" command, which would
%% bring you back to a bare lattice without errors. The command only works
%% if the chosen sequence had been activated before with the "USE" command,
%% otherwise a warning will be issued and MAD-X will continue with the
%% unmodified current sequence. This command is particularly useful for
%% commands that do not have the sequence as an argument like "EMIT" or
%% "IBS". 


%\input{Introduction/label}
\section{Identifiers or Labels}
\label{sec:label}
A label begins with a letter, followed by up to fifteen letters, digits,
decimal points (.), or underscores (\_). Characters beyond the sixteenth
are dropped, but should be avoided, and the resulting sequence must be
unique. 

A label may refer to a keyword, an element, a beam-line, a sequence,
etc.   

The \madx keywords are protected; using one of them as a label
results in a fatal error.  


%\input{Introduction/attribute}
\section{Command Attributes}
\label{sec:attribute}

\begin{itemize}
	\item A \href{name.html}{name or string attribute} refers to an object, or a string. 
	\item A \href{logical.html}{logical attribute} selects or deselects an option. 
	\item An \href{integer.html}{integer attribute} is a counter, as for repetition in a beam line. 
        \item A \href{real.html}{real attribute} defines a value stored
          as double precisiom data.  
	\item A \href{expression.html}{real expression} defines a datum
          for a command, it may be varied in matching. An expression is
          built of a combination of
          \href{expression.html#operator}{operator} and
          \href{expression.html#operand}{operand}. 
	\item A \href{constraint.html}{constraint}, specifies a matching constraint. 
	\item A \href{variable.html}{variable name} selects a variable to be matched. 
\end{itemize}


%\input{Introduction/name}
\section{Name or String Attributes}
\label{sec:name}
A name or string attribute often selects one of a set of options: 
\begin{verbatim}
use, period=lhc;    // expand the LHC sequence
\end{verbatim} 

It may also refer to a user-defined object: 
\begin{verbatim}
twiss, file=optics;    // specifies the name of the OPTICS output file
\end{verbatim} 

It may also define a string: 
\begin{verbatim}
title, "LHC version 6.2";
\end{verbatim} 

The case of letters is only significant if a string is enclosed in
quotes, otherwise all characters are converted to lower at reading. On
the other hand, strings that do not contain blanks do not need to be
enclosed in quotes. 

Example:
\begin{verbatim}
call, file="my.file";
call, file=my.file;
call, file=MY.FILE;
call, file="MY.FILE";
call, file='MY.FILE';
\end{verbatim} 
In the first three cases, \madx will try to read a file my.file, in the
last two it will try to read MY.FILE.  


%\input{Introduction/string}
\section{String Attributes}
\label{sec:string}
A string attribute makes alphanumeric information available, e.g. a
title or a file name. It can contain any characters, enclosed in single
(') or double (") quotes, except for quotes of the type used as its
delimiter.  

Examples: 
\begin{verbatim}
TITLE,'This is a title for the program run "test"';

system,"ln -fns some-lengthy-directory-name local-link";
\end{verbatim}


%\input{Introduction/logical}
\section{Logical Attributes}
\label{sec:logical}
Many commands in \madx require the setting of logical values (flags) to
represent the on/off state of an option. A logical value "flag" can be
set in two ways:  
\begin{verbatim}
flag | flag = true
\end{verbatim} 

It can be reset by: 
\begin{verbatim}
-flag | flag=false
\end{verbatim} 

Example: 
\begin{verbatim}
option, -echo;  // switch off copying the input to the standard output
\end{verbatim} 

The default for a logical flag is normally false, but can be found e.g. for options by the command  
\begin{verbatim}
help, option;
\end{verbatim}


%\input{Introduction/integer}
\section{Integer Attributes}
\label{sec:integer}
An integer attribute usually denotes a count. Example: 
\begin{verbatim}
myline: line = (-3*(a,b,c));
\end{verbatim} 

In this case, a litteral integer is requested; however, in the following 
\begin{verbatim}
rfc: rfcavity, harmon = 12345;
\end{verbatim} 

or 
\begin{verbatim}
rfc: rfcavity, harmon = num;
\end{verbatim} 

"num" may be an integer variable, a real variable, or an expression.  In
the two latter cases, the value is truncated. 



%\input{Introduction/real}
\section{Real Attributes}
\label{sec:real}
Most attributes are of type REAL and are treated internally as double
precision values. They may be set by integer values, real values,  or
expressions. 

Example:  
\begin{verbatim}
ddd:   drift, l = 1.2345;
dddd:  drift, l = ddd->l-0.3;
\end{verbatim}


%\input{Introduction/expression}
%  Changed by: Ghislain Roy, 12-Dec-2013: updated physicial constants
%  to PDG2012 values; very old values were pre PDG2010.
\section{\href{expression}{Real Expressions}}
\label{sec:expression}
To facilitate the definition of interdependent quantities, any real
value and integer value can be entered as an arithmetic expression. When
a value used in an expression is redefined by the user or changed in a
matching process, the expression is reevaluated. Expression definitions
may be entered in any order. \madx evaluates them in the correct order
before it performs any computation. At evaluation time all operands used
must have values assigned.  

An expression is built from a combination of
\hyperlink{operator}{operator} and \hyperlink{operand}{operand}, and it
may contain \hyperlink{random}{random generators}.   

\subsection{\href{operator}{Operators in Arithmetic Expressions}} 
\label{subsec:operator}
An expression can be formed using the following operators: 

\subsubsection{Arithmetic operators}
\begin{madlist}
  \ttitem{+} Addition, 
  \ttitem{-} Subtraction, 
  \ttitem{*} Multiplication, 
  \ttitem{/} Division, 
  \ttitem{\^\ } Exponentiation. 
\end{madlist}

\subsubsection{\href{function}{Ordinary Functions}}
\label{subsubsec:function}
\begin{madlist}
  \ttitem{SQRT(x)} square root, 
  \ttitem{LOG(x)}  natural logarithm, 
  \ttitem{LOG10(x)} logarithm base 10, 
  \ttitem{EXP(x)} exponential, 
  \ttitem{SIN(x)} trigonometric sine, 
  \ttitem{COS(x)} trigonometric cosine, 
  \ttitem{TAN(x)} trigonometric tangent, 
  \ttitem{ASIN(x)} arc sine, 
  \ttitem{ACOS(x)} arc cosine, 
  \ttitem{ATAN(x)} arc tangent, 
  \ttitem{SINH(x)} hyperbolic sine, 
  \ttitem{COSH(x)} hyperbolic cosine, 
  \ttitem{TANH(x)} hyperbolic tangent, 
  \ttitem{ABS(x)} absolute value; 
\end{madlist}

\subsubsection{\href{random}{Random Number Generators}}
\label{subsubsec:random}
\begin{madlist}
  \ttitem{RANF()} random number, uniformly distributed in [0,1], 
  \ttitem{GAUSS()} random number, gaussian distribution with unit
  standard deviation,  
  \ttitem{TGAUSS(x)} random number, gaussian distribution with unit
  standard deviation, truncated at x standard deviations;  
\end{madlist}

in the above cases, "x" can be any expression, i.e. contain other
functions, variable or constant expressions. To initialize the \madx
random generator use the
\href{../error/error_option.html#EOPTION}{Eoption command}.  

\subsubsection{\href{table}{Table Access Functions}}
\label{subsubsec:table}

\begin{madlist}
  \ttitem{table(x,z)} accesses value of the named table column "z"
  of table "x"; example: table(summ,q1) returns the hor. tune of
  the Twiss summary table "summ".  
  \ttitem{table(x,y,z)} accesses value of the named table column "z"
  for element "y" (first table row with that name) of table "x";
  example: table(twiss,mb.12,betx) returns the beta\_x at
  element mb.12 from the Twiss table "twiss".   When the element
  is called with its proper name, as in the example above, the
  value is returned at the first occurrence of the element of
  this name. If the value is needed at a occurrence number: NNN,
  then "[NNN]" has to be appended to the name, e.g. in the above
  example one obtains the betx of the 23th occurrence of the
  element "mb.12" by changing the example to:
  "table(twiss,mb.12[23],betx)". Mind you that the old, but
  little known, form: "table(twiss,mb.12-\textgreater 23,betx)"
  continues to work. Lastly, if NNN exceeds the maximum
  occurrence number the return value is arbitrarily small.  
\end{madlist}

Beware: 
\begin{itemize}
   \item  Unnamed Drifts are not included in the table name
          database, so as to speed up the search for "real"
          elements. Therefore, those  unnamed drifts cannot be
          found. However, named drifts can be searched for.  
   \item  Due to the importance of finding elements in the table
          for a proper functioning of the \madx runs, the programs
          throws a "fatal\_error" if an element cannot be found in the
          table.   
\end{itemize}

There is a second option of this function with 3 entries  
\begin{itemize}
    \item table(x,z,N\_row): accesses the value of the named table
          column  "z" at the "N\_row" number of rows of table "x" (row
          numbers start at  1); example: table(twiss,betx,370) returns
          the beta\_x at row number  "370" of the Twiss table
          "twiss". The return value is zero if "N\_row"  is outside of
          the allowed range.
\end{itemize}

Note that "N\_row" has to be a number and not a  variable. However, the
\href{../control/special.html#macro}{Macro facility} in \madx  allows
one to use a variable instead.   

A typical example could look like this, in fact the square root of betx
(user defined variable myvar) is added to the twiss table:  
\begin{verbatim}
myvar := sqrt(table(twiss,betx));
select, flag=twiss, column=name, s, myvar, betx;
twiss, file;
\end{verbatim}

Or another arbitrary test case of adding k1l taken from the Twiss table: 

Define macro: 
\begin{verbatim}
mycrap(xx,yy,zz): macro = {myval = table(xx,yy,zz);};
\end{verbatim}

Use macro in loop: 
\begin{verbatim}
i = 0;
incval = 0;
while (i < 100) {
value,i;
exec,mycrap(twiss,k1l,$i);
incval = incval + myval;
value,i,myval,incval;                
i = i + 1;
}
\end{verbatim}

\subsubsection{Features as of Version 3\_03\_50}

\begin{itemize}
  \item  FILL, TABLE=t, ROW=n; \\
    fill a table row with the present variable values. If ROW is
    negative or missing a new row is created. If ROW is greater than the
    number of rows, the last row is selected without creating a new row.  

  \item SETVARS, TABLE=t, ROW=n; \\
    set variables according to the column names of the given table and
    the values of the given row. if ROW is negative, missing or greater
    than the number of rows, the last row is selected. 
\end{itemize}

An example can be found at:
\href{http://cern.ch/frs/mad-X_examples/special_features}{Special
  Features} 

The length of a table can be determined by using the attribute
"tablelength" via table("your\_table\_name", tablelength). This is
useful when creating a table from existing ones. See an example at:
\href{../Introduction/select.html#screate}{user table II} 


\subsection{\href{operand}{Operands in Arithmetic Expressions}} 
\label{subsec:operand}
An expression may contain the following operands:  

\subsubsection{Literal Constants} 
Numerical values are entered like FORTRAN constants. Real values are
accepted in INTEGER or REAL format. The use of a decimal exponent,
marked by the letter D or E, is permitted.  

Examples: 
\madxmp{
1, 10.35, 5E3, 314.1592E-2
}

\subsubsection{\href{constant}{Symbolic constants}} 
\label{subsubsec:symbolic_const}
\madx recognizes some \hyperlink{constant}{mathematical and physical
  constants}. Their names must not be used for user-defined labels.  

Additional symbolic constants may be defined to simplify their repeated
use in statements and expressions.  
\madbox{
CONST name=constant-expression;
}
defines a real constant with the name given. An existing symbolic
constant can be redefined, but it cannot change in a matching procedure.  

Example: 
\madxmp{CONST IN = 0.0254;}

\begin{table}[ht]
\caption{Predefined Symbolic Constants in \madx}
\vspace{1ex}
\begin{center}
\begin{tabular}{|l|c|c|c|}
\hline
\textbf{mad name} & \textbf{symbol} & \textbf{value used} & \textbf{unit} \\ 
\hline
PI & $\pi$ & 4 * atan(1) & 1 \\ 
TWOPI & $2\pi$ & 2 * PI & 1 \\ 
DEGRAD & $180/\pi$ & 180 / PI  & deg/rad \\ 
RADDEG & $\pi/180$ & PI / 180 & rad/deg \\ 
E & e & exp(1) & 1 \\ 
EMASS & $m_e$ & $0.510998928\times 10^{-3}$& GeV \\ % very old value  .510998902*10(-3)   
PMASS & $m_p$ & 0.938272046 & GeV \\ % very old value .938271998  
MUMASS & $m_\mu$ & 0.1056583715 & GeV \\ % very old value .1056583568 
CLIGHT & $c$ & $2.99792458\times 10^{8}$ & m/s \\ 
QELECT & $e$ & $1.602176565\times 10^{-19}$ & A.s \\ % very old value 1.602176462e-19 
\hline
\end{tabular}
\end{center}
\end{table}

\subsubsection{Parameter labels} 
Often a set of numerical values depends on a common variable
parameter. Such a parameter must be defined as a
\href{parameter.html}{global parameter}. A global parameter always has a
current value; however, this value may be re-evaluated or not, depending
on the parameter definition:  
\begin{verbatim}
x = a;
\end{verbatim} 
x is set to the current value of a and not changed, even if a
changes. This makes assignments such as  
\begin{verbatim}
x = x + 1;
\end{verbatim} 
perfectly valid (this replaces the old SET instruction). 

The definition of the deferred expression  
\begin{verbatim}
x := a;
\end{verbatim} 
assign the current value of a to x every time x is used, i.e. it is
re-evaluated using the latest value of a; therefore,  
\begin{verbatim}
x := x + 1;
\end{verbatim} 
results in an infinite loop (!) when x is used (error abort). 

Of course, the following definitions are equivalent:  
\begin{verbatim}
x = 0.1;
x := 0.1;
\end{verbatim}

When such a parameter is used in an expression, \madx uses the current
value of the parameter if the expression is deferred:  

Example: 
\madxmp{
x := 1.0; \\
d1: drift, l =  x; \\
d2: drift, l := 2.0 - x; \\
}
When the value of x is changed, the length of the drift d1 remains
unchanged, that of d2 is recalculated.   

\subsubsection{Element or Command Attributes} 
In arithmetic expressions the attributes of physical elements or
commands can occur as operands. They are named respectively by  
\madbox{
element-name->attribute-name\\
command-name->attribute-name
}

Values are assigned to attributes in element definitions or commands. 

Example: 
\madxmp{
xxxxxxxx\= \kill
D1:     \>DRIFT, L= 1.0; \\
D2:     \>DRIFT, L= 2.0 - D1->L;
}
%\begin{verbatim}
%D1: DRIFT, L=1.0;
%D2: DRIFT, L=2.0-D1->L;
%\end{verbatim} 
D1-\textgreater L refers to the length L of the drift space D1.  

\subsection{\href{defer}{Expressions and Random Values}} 
\label{subsec:expr_rnd}
The definition of random machine imperfections requires evaluation of
expressions containing random functions. These are evaluated like any
other expression when the expression is used, i.e. only once if a "="
assignment refers to it, or every time if the assignment is ":="; this
latter case is used by the error generation routines.  

Example: 
\begin{verbatim}
a := 3*ranf();
\end{verbatim} 
Every time a is used, it gets a random value assigned from a uniform
distribution between 0 and 3.  

\begin{verbatim}
error:  ealign,range,dx:=sigma*gauss();
\end{verbatim} 
All elements in range are assigned independent random displacements
sampled from a Gaussian distribution with standard deviation sigma.  



%\input{Introduction/constraint}
\section{Constraints}
\label{sec:constraints}
In matching it is desired to specify equality constraints, as well as
lower and upper limits for a quantity. \madx accepts the following forms
of constraints:  
%% \begin{verbatim}
%% ! equality constraint:
%% name = expression

%% ! upper limit:
%% name < expression

%% ! lower limit:
%% name > expression

%% ! both upper and lower limit for the same name:
%% name < expression, name > expression
%% \end{verbatim}

\madbox{
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\= \kill
name = expression                    \>! equality constraint \\
name < expression                    \>! upper limit \\
name > expression                    \>! lower limit \\
name < expression, name > expression \>! both upper and lower limit \\
                                     \>! for the same name
}

%\input{Introduction/variable}
\section{Variable Names}
\label{sec:variable}
A variable name can have one of the formats: 
\madbox{
 parameter-name \\
 element-name->attribute-name \\
 command-name->attribute-name \\
 beam\%sequence-name->attribute-name \\
 table(table-name,..,..)
}

The first format refers to the value of the \href{parameter.html}{global
  parameter} "parameter-name". 

The second and third formats refer to the
\href{real.html}{real attribute} "attribute-name" of the element
"element-name", or the command "command-name". 

The fourth format is specific
to beams belonging to a particular sequence (for details see
\href{sequence.html#beam}{sequences and beams}). 

The fifth format allows
extraction of variables from existing tables, as specified in
\href{expression.html#table}{table access}.  



%\input{Introduction/wildcard}
\section{Regular Expressions}
\label{sec:regex}
Some commands allow selection of items via "regular expression"
strings. Such a pattern string \textbf{must} be enclosed in single or
double quotes. \madx follows regexp (Unix regular expression patterns)
for matching. The following features are implemented:  

A "search string" below is the string containing the pattern, a "target
string" is the string being searched for a possible match with the
pattern. 

\begin{madlist}
   \ttitem{"\textasciicircum"} at the start of the search string: Match
     following search string at the start of the target string;
     otherwise the search string can start anywhere in the target
     string. To search for a  genuine "\textasciicircum" anywhere, use
     "$\backslash$\textasciicircum".  
   \ttitem{"\$"} at the end of the search string: Match preceding search
     string at the end of the target string; otherwise the search string
     can end anywhere in the target string. To search for a  genuine
     "\$" anywhere, use "$\backslash$\$".
   \ttitem{"."} stands for an arbitrary character; to search for a genuine
     ".", use "$\backslash$."
   \ttitem{"[xyz]"} stands for one character belonging to the string
     contained in brackets (example: "[abc]" means one of a, b, c).  
   \ttitem{"[a-ex-z]"} stands for ranges of characters (example:
     "[a-zA-Z]" means any letter).  
   \ttitem{"[\textasciicircum xyz]"} (i.e. a "\textasciicircum" as first
     character in a square bracket) stands for exclusion of all
     characters in the list, i.e. "[\textasciicircum a-z]" means "any
     character but a lower case letter". 
   \ttitem{"*"} allows zero or more repetitions of the preceding
     character, either specified directly, or from a list. (examples:
     "a*" means zero or more occurrences of "a",  "[A-Z]*" means zero or
     more upper-case letters).  
   \ttitem{"$\backslash$c"}  (e.g. "$\backslash$.") removes the special
     meaning of character c.  
\end{madlist}

All other characters stand for themselves. 


Example: 
%% \begin{verbatim}
%% select, flag=twiss, pattern="^d..$" ;
%% select, flag=twiss, pattern="^k.*qd.*\.r1$" ;
%% \end{verbatim}
\madxmp{
SELECT, FLAG=twiss, PATTERN="\textasciicircum d..\$" ; \\
SELECT, FLAG=twiss, PATTERN="\textasciicircum k.*qd.*$\backslash$.r1\$" ;
}
 
The first command selects all elements whose names have exactly three
characters and begin with the letter "D". The second command selects
elements beginning with the letter "K", containing the string "QD", and
ending with the string ".R1". The two occurrences of ".*" each stand for
an arbitrary number (including zero) of any character, and the
occurrence "$\backslash$." stands for a literal period.  




