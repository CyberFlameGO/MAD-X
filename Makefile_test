# |
# o---------------------------------------------------------------------o
# |
# | MAD makefile - Tests
# |
# o---------------------------------------------------------------------o
# |
# | Methodical Accelerator Design
# |
# | Copyright (c) 2011+ CERN, mad@cern.ch
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

#################################################
# testsuite

# tests list
# test-case must be short and should test features only
# test-user can be longer and should test if studies are working

test-case := test-jacobian test-jacobian-2 test-jacobian-knobs
test-user :=

# testsuite titles (attached to first rule of the suite)

test-jacobian: NDFLAGS += -suite "Jacobian testsuite"



# end of testsuite
#################################################

#################################################
# implementation

# directory selection (from tests)

ifdef TESTDIR
ifeq ($(TESTDIR),detect)
test-case := $(notdir $(wildcard tests/test-*))
test-user :=
else 
test-case := $(TESTDIR)
test-user :=
endif
endif

check-test-dirs := \
   $(foreach dir,$(test-case) $(test-user),\
     $(call exists,tests/$(dir),invalid test directory tests/$(dir)))

# tests helper

MADX    := $(PROJECT)
NDIFF   := numdiff$(ARCH)

test-%: MADX  := ../../$(MADX)
test-%: NDIFF := ../../$(NDIFF)

define run-test
$_ cd tests/$@ ; $(RM) out*.txt ; \
$(MADX) < $@.madx > out.txt ; \
$(NDIFF) -q -n -t $@ $(NDFLAGS) out.txt ref.txt cfg.txt
endef

# tests rules

.PHONY: tools tests test-case test-user

tests: tools test-case test-user
test-case: $(test-case)
test-user: $(test-user)
$(test-case) $(test-user):
	$(run-test)

# tests tools

tools: $(NDIFF)

$(NDIFF):
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ; \
     $(CP) tools/numdiff/$(NDIFF) $(NDIFF)

# end of makefile
