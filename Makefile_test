# |
# o---------------------------------------------------------------------o
# |
# | MAD makefile - Tests
# |
# o---------------------------------------------------------------------o
# |
# | Methodical Accelerator Design
# |
# | Copyright (c) 2011+ CERN, mad@cern.ch
# |
# | For more information, see http://cern.ch/mad
# |
# o---------------------------------------------------------------------o
# |
# | $Id$
# |

#################################################
# vars & macro helper

MADX    := $(PROJECT)
NDIFF   := numdiff$(ARCH)

test-%: MADX  := ../../$(MADX)
test-%: NDIFF := ../../$(NDIFF)

define run-test
$_ cd tests/$@ ; $(RM) out*.txt ; \
$(MADX) < $@.madx > out.txt ; \
$(NDIFF) -q -s -t $@ $(NDFLAGS) out.txt ref.txt cfg.txt
endef

# end of settings
#################################################

.PHONY: tools tests test-case test-user

tests: tools test-case test-user

#################################################
# testsuite

test-case: test-jacobian
test-user:

# test-rules

test-jacobian:
	$(run-test)


#################################################
# tools (numdiff)

tools: $(NDIFF)

$(NDIFF):
	$_ $(MAKE) -C tools/numdiff --no-print-directory -j5 ; \
     $(CP) tools/numdiff/$(NDIFF) $(NDIFF)

# end of makefile
