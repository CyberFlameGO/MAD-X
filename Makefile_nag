#######################################################################

# Makefile for MAD-X development version

#######################################################################

PLUGIN_SUPPORT=NO

# parameters

f95=f95
GCC_FLAGS=-c -g -m32 -Wall -D_CATCH_MEM
GCCP_FLAGS_MPARS=-c -g -O3 -m32 -funroll-loops -Wall -pedantic -D_CATCH_MEM
GCCP_FLAGS=$(GCCP_FLAGS_MPARS) -D_FULL
f95_FLAGS=-gline -g90 -c -Wc,-m32 -Wl,-m32 -C=all -maxcontin=100 -nan -ieee=full
FFLAGS77=-gline -g90 -c -Wc,-m32 -Wl,-m32 -fpp -maxcontin=100 -nan -ieee=stop -D_G95

FC=f95
FCP=$(FFLAGS77)

CC=gcc
FOPT=-Bstatic -m32

#FC6
#LIBX= -lX11 -lXdmcp -lXau -lpthread
LIBX="-L/usr/X11R6/lib" -lX11 "-L/usr/lib/" -ldl -lpthread

ifeq ($(PLUGIN_SUPPORT),YES)
  GCCP_FLAGS+= -DPLUGIN_SUPPORT
  FOPT=-Bdynamic -m32
endif

ifeq ($(OSTYPE),darwin)
# allows running of madx under Macinstosh System 10
# -fno-second-underscore  is old, do not use for more recent gnu compilers
# include headers for gxx11c
  GCCP_FLAGS_MPARS=-g -O3 -c -m32 -funroll-loops -D_CATCH_MEM -I /usr/X11R6/include/
  GCCP_FLAGS=$(GCCP_FLAGS_MPARS) -D_FULL
  FOPT= -m32
endif

default: madx

# files

madxp.o: madxp.c madxn.c madxu.c aperture.c madxe.c madxc.c matchc.c matchc2.c sxf.c makethin.c c6t.c madxreg.c madxreg.h madx.h madxl.h madxd.h madxdict.h c6t.h
	$(CC) $(GCCP_FLAGS_MPARS) madxp.c

madxpf.o: madxp.c madxn.c madxu.c aperture.c madxe.c madxc.c matchc.c matchc2.c sxf.c makethin.c c6t.c madxreg.c madxreg.h madx.h madxl.h madxd.h madxdict.h c6t.h
	$(CC) $(GCCP_FLAGS) -o madxpf.o madxp.c

twissp.o: twiss.F twiss0.fi twissa.fi twissl.fi twissc.fi twissotm.fi track.fi bb.fi name_len.fi twtrr.fi
	$(FC) $(FCP) -o twissp.o twiss.F

ptc_dummy.o: ptc_dummy.F
	$(FC) $(FCP) -o ptc_dummy.o ptc_dummy.F

surveyp.o: survey.F
	$(FC) $(FCP) -o surveyp.o survey.F

utilp.o: util.F twiss0.fi twtrr.fi
	$(FC) $(FCP) -o utilp.o util.F

dynapp.o: dynap.F deltra.fi dyntab.fi wmaxmin0.fi tunes.fi
	$(FC) $(FCP) -o dynapp.o dynap.F

ibsdbp.o: ibsdb.F ibsdb.fi name_len.fi physcons.fi
	$(FC) $(FCP) -o ibsdbp.o ibsdb.F

plotp.o: plot.F plot.fi plot_b.fi plot_c.fi plot_math.fi
	$(FC) $(FCP) -o plotp.o plot.F

soddp.o: sodd.F
	$(FC) $(FCP) -o soddp.o sodd.F

trrunp.o: trrun.F twiss0.fi name_len.fi track.fi bb.fi twtrr.fi
	$(FC) $(FCP) -o trrunp.o trrun.F

orbfp.o: orbf.F
	$(FC) $(FCP) -o orbfp.o orbf.F

emitp.o: emit.F twiss0.fi bb.fi emit.fi twtrr.fi
	$(FC) $(FCP) -o emitp.o emit.F

matchp.o: match.F name_len.fi match.fi
	$(FC) $(FCP) -o matchp.o match.F

matchsap.o: matchsa.F
	$(FC) $(FCP) -o matchsap.o matchsa.F

matchjcp.o: matchjc.F
	$(FC) $(FCP) -o matchjcp.o matchjc.F

matchlibp.o: matchlib.F
	$(FC) $(FCP) -o matchlibp.o matchlib.F

touschekp.o: touschek.F touschek.fi name_len.fi physcons.fi 
	$(FC) $(FCP) -o touschekp.o touschek.F

poissonp.o: poisson.F
	$(FC) $(FCP) -o poissonp.o poisson.F

gxx11p.o: gxx11.F
	$(FC) $(FCP) -o gxx11p.o gxx11.F

gxx11c.o: gxx11c.c
	$(CC) $(GCCP_FLAGS) -o gxx11c.o gxx11c.c

resindexp.o: resindex.F resindex.fi
	$(FC) $(FCP) -o resindexp.o resindex.F
	
fortran_flush.o: fortran_flush.F
	$(FC) $(FCP) -o fortran_flush.o fortran_flush.F

.F.o:
	$(f95) $(FFLAGS77) $<	

madxm.o: madxm.F
	$(f95) $(FFLAGS77) madxm.F

a_scratch_size.o: a_scratch_size.f90
	$(f95) $(f95_FLAGS) a_scratch_size.f90

b_da_arrays_all.o: a_scratch_size.o b_da_arrays_all.f90
	$(f95) $(f95_FLAGS) b_da_arrays_all.f90

c_dabnew.o: b_da_arrays_all.o c_dabnew.f90
	$(f95) $(f95_FLAGS) c_dabnew.f90

d_lielib.o: c_dabnew.o d_lielib.f90
	$(f95) $(f95_FLAGS) d_lielib.f90

h_definition.o: a_scratch_size.o c_dabnew.o d_lielib.o h_definition.f90
	$(f95) $(f95_FLAGS) h_definition.f90

i_tpsa.o: h_definition.o i_tpsa.f90
	$(f95) $(f95_FLAGS) i_tpsa.f90

j_tpsalie.o: i_tpsa.o j_tpsalie.f90
	$(f95) $(f95_FLAGS) j_tpsalie.f90

k_tpsalie_analysis.o: j_tpsalie.o k_tpsalie_analysis.f90
	$(f95) $(f95_FLAGS) k_tpsalie_analysis.f90

l_complex_taylor.o: k_tpsalie_analysis.o l_complex_taylor.f90
	$(f95) $(f95_FLAGS) l_complex_taylor.f90

m_real_polymorph.o: l_complex_taylor.o m_real_polymorph.f90
	$(f95) $(f95_FLAGS) m_real_polymorph.f90

n_complex_polymorph.o: m_real_polymorph.o n_complex_polymorph.f90
	$(f95) $(f95_FLAGS) n_complex_polymorph.f90

o_tree_element.o: n_complex_polymorph.o o_tree_element.f90
	$(f95) $(f95_FLAGS) o_tree_element.f90

Sa_extend_poly.o: o_tree_element.o Sa_extend_poly.f90
	$(f95) $(f95_FLAGS) Sa_extend_poly.f90

Sb_sagan_pol_arbitrary.o: Sa_extend_poly.o Sb_sagan_pol_arbitrary.f90
	$(f95) $(f95_FLAGS) Sb_sagan_pol_arbitrary.f90

Sc_euclidean.o: Sb_sagan_pol_arbitrary.o Sc_euclidean.f90
	$(f95) $(f95_FLAGS) Sc_euclidean.f90

Sd_frame.o: Sc_euclidean.o Sd_frame.f90
	$(f95) $(f95_FLAGS) Sd_frame.f90

Se_status.o: Sd_frame.o Se_status.f90 a_def_all_kind.inc a_def_sagan.inc \
	a_def_element_fibre_layout.inc
	$(f95) $(f95_FLAGS) Se_status.f90

Sf_def_all_kinds.o: Se_status.o Sf_def_all_kinds.f90
	$(f95) $(f95_FLAGS) Sf_def_all_kinds.f90

Sg_sagan_wiggler.o: Sf_def_all_kinds.o Sg_sagan_wiggler.f90
	$(f95) $(f95_FLAGS) Sg_sagan_wiggler.f90

Sh_def_kind.o: Sg_sagan_wiggler.o Sh_def_kind.f90
	$(f95) $(f95_FLAGS) Sh_def_kind.f90

Si_def_element.o: Sh_def_kind.o Si_def_element.f90
	$(f95) $(f95_FLAGS) Si_def_element.f90

Sk_link_list.o: Si_def_element.o Sk_link_list.f90
	$(f95) $(f95_FLAGS) Sk_link_list.f90

Sl_family.o: Sk_link_list.o Sl_family.f90
	$(f95) $(f95_FLAGS) Sl_family.f90

Sm_tracking.o: Sl_family.o Sm_tracking.f90
	$(f95) $(f95_FLAGS) Sm_tracking.f90

Sma_multiparticle.o: Sm_tracking.o Sma_multiparticle.f90
	$(f95) $(f95_FLAGS) Sma_multiparticle.f90
	
Sn_mad_like.o: Sma_multiparticle.o Sn_mad_like.f90
	$(f95) $(f95_FLAGS) Sn_mad_like.f90

So_fitting.o: Sn_mad_like.o So_fitting.f90
	$(f95) $(f95_FLAGS) So_fitting.f90

Sp_keywords.o: So_fitting.o Sp_keywords.f90
	$(f95) $(f95_FLAGS) Sp_keywords.f90

Spb_fake_gino_sub.o: Sp_keywords.o Spb_fake_gino_sub.f90
	$(f95) $(f95_FLAGS) Spb_fake_gino_sub.f90

Sq_orbit_ptc.o: Sp_keywords.o Sq_orbit_ptc.f90
	$(f95) $(f95_FLAGS) Sq_orbit_ptc.f90

Sqa_beam_beam_ptc.o: Sq_orbit_ptc.o Sqa_beam_beam_ptc.f90
	$(f95) $(f95_FLAGS) Sqa_beam_beam_ptc.f90

Sqb_accel_ptc.o: Sqa_beam_beam_ptc.o Sqb_accel_ptc.f90
	$(f95) $(f95_FLAGS) Sqb_accel_ptc.f90

Sr_spin.o: Sqb_accel_ptc.o Sr_spin.f90
	$(f95) $(f95_FLAGS) Sr_spin.f90

Sra_fitting.o: Sr_spin.o Sra_fitting.f90
	$(f95) $(f95_FLAGS) Sra_fitting.f90

madx_ptc_intstate.o: Sra_fitting.o madx_ptc_intstate.f90
	$(f95) $(f95_FLAGS) madx_ptc_intstate.f90

madx_ptc_setcavs.o: madx_ptc_intstate.o madx_ptc_setcavs.f90
	$(f95) $(f95_FLAGS) madx_ptc_setcavs.f90

madx_ptc_knobs.o: madx_ptc_setcavs.o madx_ptc_knobs.f90
	$(f95) $(f95_FLAGS) madx_ptc_knobs.f90

madx_ptc_module.o: madx_ptc_knobs.o madx_ptc_module.f90 
	$(f95) $(f95_FLAGS) madx_ptc_module.f90

St_pointers.o: madx_ptc_module.o madx_ptc_module.o St_pointers.f90
	$(f95) $(f95_FLAGS) St_pointers.f90

madx_ptc_trackcavs.o: madx_ptc_module.o madx_ptc_intstate.o madx_ptc_setcavs.o madx_ptc_trackcavs.f90
	$(f95) $(f95_FLAGS) madx_ptc_trackcavs.f90

madx_ptc_script.o: Sp_keywords.o madx_ptc_script.f90
	$(f95) $(f95_FLAGS) madx_ptc_script.f90

madx_ptc_eplacement.o: Sp_keywords.o madx_ptc_intstate.o madx_ptc_module.o madx_ptc_eplacement.f90
	$(f95) $(f95_FLAGS) madx_ptc_eplacement.f90

madx_ptc_normal.o: madx_ptc_module.o  madx_ptc_normal.f90
	$(f95) $(f95_FLAGS) madx_ptc_normal.f90
	
madx_ptc_twiss.o: madx_ptc_module.o madx_ptc_setcavs.o madx_ptc_distrib.o madx_ptc_knobs.o madx_ptc_twiss.f90
	$(f95) $(f95_FLAGS) madx_ptc_twiss.f90
	
madx_ptc_distrib.o: Sp_keywords.o madx_ptc_distrib.f90
	$(f95) $(f95_FLAGS) madx_ptc_distrib.f90


wrap.o: madx_ptc_module.o  madx_ptc_intstate.o \
	madx_ptc_normal.o madx_ptc_twiss.o madx_ptc_distrib.o \
	madx_ptc_setcavs.o madx_ptc_trackcavs.o \
	madx_ptc_eplacement.o madx_ptc_knobs.o \
	madx_ptc_script.o St_pointers.o \
	wrap.f90
	$(f95) $(f95_FLAGS) wrap.f90

madx_ptc_track_run.o:  Sp_keywords.o madx_ptc_script.o madx_ptc_track_run.f90
	$(f95) $(f95_FLAGS) madx_ptc_track_run.f90

user2_photon.o: madx_ptc_track_run.o user2_photon.f90 photoni.inc
	$(f95) $(f95_FLAGS) user2_photon.f90 

run_madx.o: madx_ptc_module.o run_madx.f90
	$(f95) $(f95_FLAGS) run_madx.f90

madx_main.o: run_madx.o madx_main.f90
	$(f95) $(f95_FLAGS) madx_main.f90

timest.o: timest.f90
	$(f95) $(f95_FLAGS) -o timest.o timest.f90

timex.o: timex.f90
	$(f95) $(f95_FLAGS) -o timex.o timex.f90

rplot.o: rplot.c rplot.h
	$(CC) $(GCCP_FLAGS) -c -o rplot.o rplot.c

matchptcknobs.o: matchptcknobs.c matchptcknobs.h
	$(CC) $(GCCP_FLAGS) -c -o matchptcknobs.o matchptcknobs.c

timel.o: timel.c
	$(CC) $(GCCP_FLAGS) -c -o timel.o timel.c
	
fortran_wrappers.o: fortran_wrappers.c
	$(CC) $(GCCP_FLAGS) -c fortran_wrappers.c

#Parser only
mpars: madxm.o madxp.o
	$(FC) $(FOPT) -o mpars madxm.o madxp.o $(LIBX) -lm -lc

madx: \
	madxm.o madxpf.o matchptcknobs.o twissp.o ptc_dummy.o surveyp.o orbfp.o emitp.o \
	utilp.o matchp.o matchsap.o matchjcp.o matchlibp.o touschekp.o plotp.o \
	soddp.o ibsdbp.o trrunp.o dynapp.o orbfp.o emitp.o utilp.o gxx11p.o \
	gxx11c.o resindexp.o timel.o fortran_wrappers.o fortran_flush.o
	$(FC) $(FOPT) -o madx madxm.o madxpf.o matchptcknobs.o twissp.o ptc_dummy.o \
	surveyp.o matchp.o matchsap.o matchjcp.o matchlibp.o touschekp.o plotp.o \
	soddp.o ibsdbp.o trrunp.o dynapp.o orbfp.o emitp.o utilp.o gxx11p.o \
	gxx11c.o resindexp.o timel.o fortran_wrappers.o fortran_flush.o $(LIBX) -lm -lc

madxp: \
	madx_main.o run_madx.o madxpf.o matchptcknobs.o twiss.o survey.o orbf.o emit.o util.o \
	match.o matchsa.o matchjc.o matchlibp.o touschek.o dynap.o plot.o sodd.o \
	ibsdb.o trrun.o gxx11.o gxx11c.o resindex.o timest.o timex.o \
	a_scratch_size.o b_da_arrays_all.o c_dabnew.o d_lielib.o h_definition.o \
	i_tpsa.o j_tpsalie.o k_tpsalie_analysis.o l_complex_taylor.o \
	m_real_polymorph.o n_complex_polymorph.o o_tree_element.o \
	Sa_extend_poly.o Sb_sagan_pol_arbitrary.o Sc_euclidean.o Sd_frame.o \
	Se_status.o Sf_def_all_kinds.o  Sg_sagan_wiggler.o Sh_def_kind.o \
	Si_def_element.o Sk_link_list.o Sl_family.o Sm_tracking.o \
	Sma_multiparticle.o Sn_mad_like.o So_fitting.o Sp_keywords.o \
	Spb_fake_gino_sub.o Sq_orbit_ptc.o Sqa_beam_beam_ptc.o Sqb_accel_ptc.o \
	Sr_spin.o Sra_fitting.o madx_ptc_module.o St_pointers.o madx_ptc_track_run.o \
	madx_ptc_intstate.o madx_ptc_trackcavs.o madx_ptc_setcavs.o\
	madx_ptc_script.o madx_ptc_normal.o madx_ptc_twiss.o madx_ptc_distrib.o \
	madx_ptc_knobs.o madx_ptc_eplacement.o rplot.o \
	user2_photon.o poissonp.o wrap.o fortran_wrappers.o fortran_flush.o
	$(f95) $(FOPT) -o madxp madx_main.o run_madx.o madxpf.o matchptcknobs.o twiss.o \
	survey.o orbf.o emit.o util.o match.o matchsa.o matchjc.o matchlibp.o \
	touschek.o dynap.o plot.o sodd.o ibsdb.o trrun.o gxx11.o gxx11c.o resindex.o \
	timest.o timex.o \
	a_scratch_size.o b_da_arrays_all.o c_dabnew.o d_lielib.o h_definition.o \
	i_tpsa.o j_tpsalie.o k_tpsalie_analysis.o l_complex_taylor.o \
	m_real_polymorph.o n_complex_polymorph.o o_tree_element.o \
	Sa_extend_poly.o Sb_sagan_pol_arbitrary.o Sc_euclidean.o Sd_frame.o \
	Se_status.o Sf_def_all_kinds.o  Sg_sagan_wiggler.o Sh_def_kind.o \
	Si_def_element.o Sk_link_list.o Sl_family.o Sm_tracking.o \
	Sma_multiparticle.o Sn_mad_like.o So_fitting.o Sp_keywords.o \
	Spb_fake_gino_sub.o Sq_orbit_ptc.o Sqa_beam_beam_ptc.o Sqb_accel_ptc.o \
	Sr_spin.o Sra_fitting.o madx_ptc_module.o St_pointers.o madx_ptc_track_run.o \
	madx_ptc_intstate.o madx_ptc_trackcavs.o madx_ptc_setcavs.o \
	madx_ptc_script.o madx_ptc_normal.o madx_ptc_twiss.o madx_ptc_distrib.o \
	madx_ptc_knobs.o madx_ptc_eplacement.o rplot.o \
	user2_photon.o poissonp.o wrap.o fortran_wrappers.o fortran_flush.o\
	$(LIBX) -lm -lc

clean:
	rm -f *.o
	rm -f *.g90
	rm -f *.mod
	rm -f core
	rm -f *~
